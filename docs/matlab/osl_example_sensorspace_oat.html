---
layout: matlab_wrapper
title: OAT 1 - Sensorspace ERF Analysis
resource: true
categories: examples
---

<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>OAT 1 - Sensorspace ERF Analysis</title><meta name="generator" content="MATLAB 8.4"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-04-20"><meta name="DC.source" content="osl_example_sensorspace_oat.m"></head><body><div class="content"><h1>OAT 1 - Sensorspace ERF Analysis</h1><!--introduction--><p>In this practical we will work with a single subject's data from an emotional faces task (data courtesy of Susie Murphy) and perform an ERF analysis in sensor space.</p><p>We will go through the following steps:</p><div><ol><li>Prepare data for OAT analysis</li><li>Bandpass filter data and split into epochs</li><li>Compute a first level GLM analysis with OAT</li><li>Visualise results with FieldTrip</li></ol></div><p>Please read each cell in turn before copying it's contents either directly into the MatLab console or your own blank script. By the end of this session you should have created your own template analysis script which can be % applied to further analysis.</p><p>We will work with a single subject's data from an emotional faces task and perform an ERF analysis in sensor space. This will use the following files, which should be in the example_data directory:</p><div><ul><li>Asss_fif_spm12_meg25.mat - an SPM MEEG object that has continuous data that has already been SSS Maxfiltered and downsampled to 250 Hz.</li><li>eAsss_fif_spm12_meg25.mat - an SPM MEEG object that has the same data epoched into the different task conditions.</li></ul></div><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">A QUICK SUMMARY OF OAT</a></li><li><a href="#2">SETUP THE MATLAB PATHS</a></li><li><a href="#3">INITIALISE GLOBAL SETTINGS FOR THIS ANALYSIS</a></li><li><a href="#4">SET UP THE SUBJECTS FOR THE ANALYSIS</a></li><li><a href="#5">SETUP SENSOR SPACE SOURCE RECON</a></li><li><a href="#6">SETUP THE FIRST LEVEL GLM</a></li><li><a href="#7">VIEW OAT SETTINGS</a></li><li><a href="#8">CHECK OVER OAT SETTINGS</a></li><li><a href="#9">RUN OAT</a></li><li><a href="#10">VIEW RESULTS</a></li><li><a href="#11">GENERATE REPORT</a></li><li><a href="#12">OAT RESULTS STRUCTURE</a></li><li><a href="#13">VIEW THE GLM DESIGN MATRIX</a></li><li><a href="#14">VISUALISE USING FIELDTRIP</a></li></ul></div><h2 id="1">A QUICK SUMMARY OF OAT</h2><p>OAT splits the analysis into 4 distinct pipeline stages. These are:</p><div><ol><li>source reconstruction. Note that this stage is still used in a sensor space analysis in order to setup the data</li><li>first-level GLM trial-wise analysis</li><li>subject-level fixed effects averaging over multiple sessions</li><li>group-level GLM subject-wise analysis</li></ol></div><p><img vspace="5" hspace="5" src="oat_stage_summary.jpg" alt=""> </p><p>Since we are only analyzing a single session for a single subject here, we will only use the first two stages.</p><h2 id="2">SETUP THE MATLAB PATHS</h2><p>make sure that fieldtrip and spm are not in your matlab path</p><pre class="codeinput">setenv(<span class="string">'OSLDIR'</span>,<span class="string">'/Users/andrew/Software/Matlab/osl2.1/'</span>)
addpath(genpath(getenv(<span class="string">'OSLDIR'</span>)));
osl_startup(osldir);
</pre><h2 id="3">INITIALISE GLOBAL SETTINGS FOR THIS ANALYSIS</h2><p>This cell sets the directory that OAT will work in. Change the workingdir variable to correspond to the correct directory on your computer before running the cell.</p><pre class="codeinput"><span class="comment">% directory where the data is:</span>
datadir = fullfile(osldir,<span class="string">'example_data'</span>,<span class="string">'faces_singlesubject'</span>,<span class="string">'spm_files'</span>);

<span class="comment">% directory to put the analysis in</span>
workingdir = fullfile(osldir,<span class="string">'example_data'</span>,<span class="string">'faces_singlesubject'</span>);
</pre><h2 id="4">SET UP THE SUBJECTS FOR THE ANALYSIS</h2><p>Specify a list of the fif files, structural files (not applicable for this practical) and SPM files (which will be created). It is important to make sure that the order of these lists is consistent across sessions. Note that here we only have 1 subject, but more generally there would be more than one. For example:</p><p><tt>fif_files{1}=[testdir '/fifs/sub1_face_sss.fif'];</tt> <tt>fif_files{2}=[testdir '/fifs/sub2_face_sss.fif'];</tt></p><p>etc...</p><p><tt>spm_files{1} = [workingdir '/sub1_face_sss.mat'];</tt></p><p><tt>spm_files{2} = [workingdir '/sub2_face_sss.mat'];</tt></p><p>etc...</p><pre class="codeinput"><span class="comment">% clear old spm files</span>
clear <span class="string">spm_files_continuous</span> <span class="string">spm_files_epoched</span>

spm_files_continuous{1}=[datadir <span class="string">'/Aface_meg1.mat'</span>];
spm_files_epoched{1}=[datadir <span class="string">'/eAface_meg1.mat'</span>];
</pre><h2 id="5">SETUP SENSOR SPACE SOURCE RECON</h2><p>This stage sets up the source reconstruction stage of an OAT analysis. The source_recon stage is always run even for a sensorspace analysis, though in these cases it simply prepares the data for subsequent analysis. In this example we define our input files (<tt>D_continuous</tt> and <tt>D_epoched</tt>) and conditions before setting a time frequency window from -200ms before stimulus onset to +400ms and 4 to 100Hz. The source recon method is set to 'none' as we are performing a sensorspace analysis The <tt>oat.source_recon.dirname</tt> is where all the analysis will be stored. This includes all the intermediate steps, diagnostic plots and final results.</p><pre class="codeinput">oat=[];
oat.source_recon.D_epoched=spm_files_epoched; <span class="comment">% this is passed in so that the bad trials and bad channels can be read out</span>
oat.source_recon.D_continuous=spm_files_continuous;
oat.source_recon.conditions={<span class="string">'Motorbike'</span>,<span class="string">'Neutral face'</span>,<span class="string">'Happy face'</span>,<span class="string">'Fearful face'</span>};
oat.source_recon.freq_range=[4 100]; <span class="comment">% frequency range in Hz</span>
oat.source_recon.time_range=[-0.2 0.4];
oat.source_recon.method=<span class="string">'none'</span>;
oat.source_recon.normalise_method=<span class="string">'none'</span>;

<span class="comment">% Set this to something specific</span>
oat.source_recon.dirname = [workingdir <span class="string">'/sensorspace_erf'</span>];
</pre><h2 id="6">SETUP THE FIRST LEVEL GLM</h2><p>This cell defines the GLM parameters for the first level analysis. Critically this includes the design matrix (in Xsummary) and contrast matrix Xsummary is a parsimonious description of the design matrix. It contains values <tt>Xsummary{reg,cond}</tt>, where reg is a regressor index number and cond is a condition index number. This will be used (by expanding the conditions over trials) to croat_settingse the (num_regressors x num_trials) design matrix: Each contrast is a vector containing a weight per condition defining how the condition parameter estimates are to be compared. Each vector will produce a different t-map across the sensors. Contrasts 1 and 2 describe positive correlations between each sensors activity and the presence of a motorbike or face stimulus respectively. Contrast 3 tests whether each sensors activity is larger for faces than motorbikes.</p><pre class="codeinput">Xsummary={};
Xsummary{1}=[1 0 0 0];Xsummary{2}=[0 1 0 0];Xsummary{3}=[0 0 1 0];Xsummary{4}=[0 0 0 1];
oat.first_level.design_matrix_summary=Xsummary;

<span class="comment">% contrasts to be calculated:</span>
oat.first_level.contrast={};
oat.first_level.contrast{1}=[3 0 0 0]'; <span class="comment">% motorbikes</span>
oat.first_level.contrast{2}=[0 1 1 1]'; <span class="comment">% faces</span>
oat.first_level.contrast{3}=[-3 1 1 1]'; <span class="comment">% faces-motorbikes</span>
oat.first_level.contrast_name{1}=<span class="string">'motorbikes'</span>;
oat.first_level.contrast_name{2}=<span class="string">'faces'</span>;
oat.first_level.contrast_name{3}=<span class="string">'faces-motorbikes'</span>;

oat.first_level.cope_type=<span class="string">'cope'</span>;
oat.first_level.report.first_level_cons_to_do=[2 1 3];
oat.first_level.bc=[0 0 0];

oat = osl_check_oat(oat);
</pre><h2 id="7">VIEW OAT SETTINGS</h2><p>As well as using the settings we specified in the previous cell, calling osl_check_oat has filled in a bunch of other settings as well.</p><pre class="codeinput">oat
oat.source_recon
oat.first_level
</pre><h2 id="8">CHECK OVER OAT SETTINGS</h2><p>The <tt>osl_check_oat.m</tt> function should be used to setup the settings for these three stages of the pipeline.</p><p>to see what the mandatory fields are. Note that you MUST specify:</p><div><ul><li><tt>oat.source_recon.time_range</tt></li><li><tt>oat.source_recon.conditions</tt></li><li><tt>oat.source_recon.D_continuous</tt></li><li>|oat.source_recon.D_epochedv</li></ul></div><p>Descriptions of what these correspond to are also displayed when you type <tt>help osl_check_oat</tt> in to the matlab console.</p><p>We are only interested in the first two stages of an OAT analysis, as we are not doing any group analysis here:</p><div><ul><li><tt>oat.source_recon</tt></li><li><tt>oat.first_level</tt></li></ul></div><p>Each of these contains the settings for the relevant stages of the pipeline. You can read the Pipeline Stages&#157; section of the OSL manual to get more description about these two stages.</p><p>Take a look at <tt>oat.source_recon.dirname</tt>. This will be the name of the directory (full path) where the OAT will be stored, and is given a <tt>.oat</tt> extension. [Note that each OAT directory is associated with a specific source recon; a new source recon will overwrite an old directory if the same <tt>oat.source_recon.dirname</tt> is used, and the old source recon results will be lost. Hence, you should ensure that you change oat.source_recon.dirname for a new source recon analysis, if you want to avoid overwriting an old one.]</p><h2 id="9">RUN OAT</h2><p>The OAT structure you have created, oat, should be passed to the function osl_run_oat.m, to run the pipeline. However, the OAT structure should contain a structure (<tt>oat.to_do</tt>), which is a list of binary values indicating which part of the pipeline is to be run. E.g. <tt>oat.to_do=[1 1 0 0];</tt> will run just the source recon and first level stages, whereas <tt>oat.to_do=[1 1 1 1];</tt> will run all four (source-recon, first level, subject-level and group level). Here we are not doing any group analysis, so we need:</p><p><tt>oat.to_do=[1 1 0 0];</tt></p><pre class="codeinput">oat.to_do=[1 1 0 0];
oat = osl_run_oat(oat);
</pre><h2 id="10">VIEW RESULTS</h2><p>The OAT runs GLM across all time-points and sensors. The results are plotted for the sensor with the highest statistic for the faces contrast. The COPE is plotted on the left and the t-stat on the right.</p><p><img vspace="5" hspace="5" src="osl_example_sensorspace_oat_stats_tc.png" alt=""> </p><h2 id="11">GENERATE REPORT</h2><p>The report creates a useful summary of the OAT results. You can click through a log files from the analysis as well as range of diagnostic figures from the source recon and results from the first level.</p><pre class="codeinput">oat.first_level.report.modality_to_do=<span class="string">'MEGPLANAR'</span>;
report = oat_first_level_stats_report(oat,oat.first_level.results_fnames{1});

<span class="comment">% open the report in matlabs html browser</span>
open(oat.results.report.html_fname);
</pre><h2 id="12">OAT RESULTS STRUCTURE</h2><p>Run the following code to see what oat.results contains. This includes:</p><div><ul><li><tt>oat.results.logfile</tt> - (a file containing the matlab output)</li><li><tt>oat.results.report</tt> - (a file corresponding to a web page report with diagnostic plots)</li></ul></div><p>It is highly recommended that you always inspect the <tt>oat.results.report</tt>, to ensure that OAT has run successfully.</p><p>Open the web page report indicated in oat.results.report in a web browser (there will also be a link to this available in the Matlab output). This displays diagnostic plots.</p><div><ul><li>At the top of the file is a link to oat.results.logfile (a file containing the matlab output) - you should check this for any errors or unusual warnings.</li><li>Then there will be a list of reports for each OAT stage.</li></ul></div><p>Click on the "First level (epoched)" link to bring up the first level reports.</p><p>This brings up a list of sessions. Here we have only preprocessed one session. Click on the "Session 1 report" link to bring up the diagnostic plots for session 1 and take a look.</p><p>The results can be loaded back into matlab using oat_load_results. This is useful for checking over results of the GLM or as the basis for further analyses.</p><pre class="codeinput"><span class="comment">% Show OAT results</span>
disp(<span class="string">'oat.results:'</span>);
disp(oat.results);
</pre><h2 id="13">VIEW THE GLM DESIGN MATRIX</h2><p>Running the OAT analysis will create an OAT output directory (whose name is the name set in oat.source_recon.dirname with a ?.oat? suffix added). This contains all you need to access the results of the analysis. It contains the analysis settings and the pointers to files containing the results for each of the pipeline stages that have been run. The oat can be loaded into Matlab with the call:</p><p><tt>oat=osl_load_oat(oat.source_recon.dirname);</tt></p><p>Each stage of the OAT pipeline will also have stored its results in a .mat data file saved in the OAT output directory. Note that for source_recon and first_level these are saved separately for each subject. The names of these files are stored in the corresponding part of the OAT structure, e.g.</p><div><ul><li><tt>oat.source_recon.results_fnames</tt></li><li><tt>oat.first_level.results_fnames</tt></li><li><tt>oat.subject_level.results_fnames</tt></li><li><tt>oat.group_level.results_fnames</tt></li></ul></div><p>These can loaded into Matlab, e.g. to load session 1?s source reconstruction results use the call:</p><p><tt>recon_results= oat_load_results(oat,oat.source_recon.results_fnames{1})</tt></p><p>E.g. to load session 2?s first level stats results, you can use the call:</p><p><tt>stats= oat_load_results(oat,oat.first_level.results_fnames{2})</tt></p><p>Run the following code to load in the stats results from the GLM you just ran and plot the design matrix. This is the nconditions by ntrials design matrix which is used to fit the GLM (NOTE that column 1 is motorbikes, columns 2-4 are faces)</p><pre class="codeinput"><span class="comment">% load first-level GLM result</span>
stats1=oat_load_results(oat,oat.first_level.results_fnames{1});

<span class="comment">% Plot design matrix</span>
figure;imagesc(stats1.x);title(<span class="string">'GLM design matrix'</span>);xlabel(<span class="string">'regressor no.'</span>);ylabel(<span class="string">'trial no.'</span>);
</pre><h2 id="14">VISUALISE USING FIELDTRIP</h2><p>note that this produces an interactive figure, with which you can: * draw around a set of sensors * click in the drawn box to produce a plot of the time series * on the time series plot you can draw a time window * and click in the window to create a topoplot averaged over that time window (which is itself interactive....!)</p><pre class="codeinput">S2=[];
S2.oat=oat;
S2.stats_fname=oat.first_level.results_fnames{1};
S2.modality=<span class="string">'MEGPLANAR'</span>; <span class="comment">% can also set this to 'MEGMAG'</span>
S2.first_level_contrast=[3]; <span class="comment">% view faces-motorbikes contrast</span>
S2.view_cope=1; <span class="comment">% set to 0 to see the t-stat</span>

<span class="comment">% calculate t-stat using contrast of absolute value of parameter estimates</span>
[cfg, dats, fig_handle]=oat_stats_multiplotER(S2);
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% OAT 1 - Sensorspace ERF Analysis
%
% In this practical we will work with a single subject's data from an
% emotional faces task (data courtesy of Susie Murphy) and perform an ERF
% analysis in sensor space.
%
% We will go through the following steps:
%
% # Prepare data for OAT analysis
% # Bandpass filter data and split into epochs
% # Compute a first level GLM analysis with OAT
% # Visualise results with FieldTrip
%
% Please read each cell in turn before copying it's contents either directly  
% into the MatLab console or your own blank script. By the end of this session 
% you should have created your own template analysis script which can be %
% applied to further analysis.
%
% We will work with a single subject's data from an emotional faces task and perform an ERF analysis in sensor space. 
% This will use the following files, which should be in the example_data
% directory:
%
% * Asss_fif_spm12_meg25.mat - an SPM MEEG object that has continuous data that has already been SSS Maxfiltered and downsampled to 250 Hz.
% * eAsss_fif_spm12_meg25.mat - an SPM MEEG object that has the same data epoched into the different task conditions.

%% A QUICK SUMMARY OF OAT
%
% OAT splits the analysis into 4 distinct pipeline stages. These are:
%
% # source reconstruction. Note that this stage is still used in a sensor space analysis in order to setup the data
% # first-level GLM trial-wise analysis
% # subject-level fixed effects averaging over multiple sessions
% # group-level GLM subject-wise analysis
%
% <<oat_stage_summary.jpg>>
%
% Since we are only analyzing a single session for a single subject here, we will only use the first two stages.


%% SETUP THE MATLAB PATHS
% make sure that fieldtrip and spm are not in your matlab path

setenv('OSLDIR','/Users/andrew/Software/Matlab/osl2.1/')
addpath(genpath(getenv('OSLDIR')));
osl_startup(osldir);

%% INITIALISE GLOBAL SETTINGS FOR THIS ANALYSIS
% This cell sets the directory that OAT will work in. Change the workingdir variable to correspond to the correct directory on your computer before running the cell.

% directory where the data is:
datadir = fullfile(osldir,'example_data','faces_singlesubject','spm_files');

% directory to put the analysis in
workingdir = fullfile(osldir,'example_data','faces_singlesubject');

%% SET UP THE SUBJECTS FOR THE ANALYSIS
%
% Specify a list of the fif files, structural files (not applicable for this practical) and SPM files (which will be created). It is important to make sure that the order of these lists is consistent across sessions. Note that here we only have 1 subject, but more generally there would be more than one. For example:
%
% |fif_files{1}=[testdir '/fifs/sub1_face_sss.fif'];|
% |fif_files{2}=[testdir '/fifs/sub2_face_sss.fif'];|
%
% etc...
%
% |spm_files{1} = [workingdir '/sub1_face_sss.mat'];|
%
% |spm_files{2} = [workingdir '/sub2_face_sss.mat'];|
%
% etc...

% clear old spm files
clear spm_files_continuous spm_files_epoched

spm_files_continuous{1}=[datadir '/Aface_meg1.mat'];
spm_files_epoched{1}=[datadir '/eAface_meg1.mat'];

%% SETUP SENSOR SPACE SOURCE RECON
% This stage sets up the source reconstruction stage of an OAT analysis. The source_recon stage is always run even for a sensorspace analysis, though in these cases it simply prepares the data for subsequent analysis.
% In this example we define our input files (|D_continuous| and |D_epoched|) and conditions before setting a time frequency window from -200ms before stimulus onset to +400ms and 4 to 100Hz. The source recon method is set to 'none' as we are performing a sensorspace analysis
% The |oat.source_recon.dirname| is where all the analysis will be stored. This includes all the intermediate steps, diagnostic plots and final results.

oat=[];
oat.source_recon.D_epoched=spm_files_epoched; % this is passed in so that the bad trials and bad channels can be read out
oat.source_recon.D_continuous=spm_files_continuous;
oat.source_recon.conditions={'Motorbike','Neutral face','Happy face','Fearful face'};
oat.source_recon.freq_range=[4 100]; % frequency range in Hz
oat.source_recon.time_range=[-0.2 0.4];
oat.source_recon.method='none';
oat.source_recon.normalise_method='none';

% Set this to something specific
oat.source_recon.dirname = [workingdir '/sensorspace_erf'];

%% SETUP THE FIRST LEVEL GLM
% This cell defines the GLM parameters for the first level analysis. Critically this includes the design matrix (in Xsummary) and contrast matrix
% Xsummary is a parsimonious description of the design matrix. It contains values |Xsummary{reg,cond}|, where reg is a regressor index number and cond is a condition index number. This will be used (by expanding the conditions over trials) to croat_settingse the (num_regressors x num_trials) design matrix:
% Each contrast is a vector containing a weight per condition defining how the condition parameter estimates are to be compared. Each vector will produce a different t-map across the sensors. Contrasts 1 and 2 describe positive correlations between each sensors activity and the presence of a motorbike or face stimulus respectively. Contrast 3 tests whether each sensors activity is larger for faces than motorbikes.

Xsummary={};
Xsummary{1}=[1 0 0 0];Xsummary{2}=[0 1 0 0];Xsummary{3}=[0 0 1 0];Xsummary{4}=[0 0 0 1];
oat.first_level.design_matrix_summary=Xsummary;

% contrasts to be calculated:
oat.first_level.contrast={};
oat.first_level.contrast{1}=[3 0 0 0]'; % motorbikes
oat.first_level.contrast{2}=[0 1 1 1]'; % faces
oat.first_level.contrast{3}=[-3 1 1 1]'; % faces-motorbikes
oat.first_level.contrast_name{1}='motorbikes';
oat.first_level.contrast_name{2}='faces';
oat.first_level.contrast_name{3}='faces-motorbikes';

oat.first_level.cope_type='cope';
oat.first_level.report.first_level_cons_to_do=[2 1 3];
oat.first_level.bc=[0 0 0];

oat = osl_check_oat(oat);

%% VIEW OAT SETTINGS
% As well as using the settings we specified in the previous cell, calling osl_check_oat has filled in a bunch of other settings as well.

oat
oat.source_recon
oat.first_level

%% CHECK OVER OAT SETTINGS
% The |osl_check_oat.m| function should be used to setup the settings for these three stages of the pipeline.  
%
% to see what the mandatory fields are. Note that you MUST specify:
%
% * |oat.source_recon.time_range|
% * |oat.source_recon.conditions|
% * |oat.source_recon.D_continuous|
% * |oat.source_recon.D_epochedv
%
% Descriptions of what these correspond to are also displayed when you type
% |help osl_check_oat| in to the matlab console.
%
% We are only interested in the first two stages of an OAT analysis, as we are not doing any group analysis here:
%
% * |oat.source_recon|
% * |oat.first_level|
%
% Each of these contains the settings for the relevant stages of the pipeline. You can read the Pipeline Stages section of the OSL manual to get more description about these two stages.
%
% Take a look at |oat.source_recon.dirname|. This will be the name of the directory (full path) where the OAT will be stored, and is given a |.oat| extension. [Note that each OAT directory is associated with a specific source recon; a new source recon will overwrite an old directory if the same |oat.source_recon.dirname| is used, and the old source recon results will be lost. Hence, you should ensure that you change oat.source_recon.dirname for a new source recon analysis, if you want to avoid overwriting an old one.]

%% RUN OAT
%
% The OAT structure you have created, oat, should be passed to the function osl_run_oat.m, to run the pipeline.
% However, the OAT structure should contain a structure (|oat.to_do|), which is a list of binary values indicating which part of the pipeline is to be run.
% E.g. |oat.to_do=[1 1 0 0];| will run just the source recon and first level stages, whereas |oat.to_do=[1 1 1 1];| will run all four (source-recon, first level, subject-level and group level).
% Here we are not doing any group analysis, so we need:
%
% |oat.to_do=[1 1 0 0];|

oat.to_do=[1 1 0 0];
oat = osl_run_oat(oat);

%% VIEW RESULTS
%
% The OAT runs GLM across all time-points and sensors. The results are
% plotted for the sensor with the highest statistic for the faces contrast.
% The COPE is plotted on the left and the t-stat on the right.
%
% <<osl_example_sensorspace_oat_stats_tc.png>>

%% GENERATE REPORT
%
% The report creates a useful summary of the OAT results. You can click
% through a log files from the analysis as well as range of diagnostic figures 
% from the source recon and results from the first level.

oat.first_level.report.modality_to_do='MEGPLANAR';
report = oat_first_level_stats_report(oat,oat.first_level.results_fnames{1});

% open the report in matlabs html browser
open(oat.results.report.html_fname);

%% OAT RESULTS STRUCTURE
%
% Run the following code to see what oat.results contains. This includes:
%
% * |oat.results.logfile| - (a file containing the matlab output) 
% * |oat.results.report| - (a file corresponding to a web page report with diagnostic plots)
%
% It is highly recommended that you always inspect the |oat.results.report|, to ensure that OAT has run successfully. 
%
% Open the web page report indicated in oat.results.report in a web browser (there will also be a link to this available in the Matlab output). This displays diagnostic plots. 
% 
% * At the top of the file is a link to oat.results.logfile (a file containing the matlab output) - you should check this for any errors or unusual warnings.
% * Then there will be a list of reports for each OAT stage. 
%
% Click on the "First level (epoched)" link to bring up the first level reports.
%
% This brings up a list of sessions. Here we have only preprocessed one session. Click on the "Session 1 report" link to bring up the diagnostic plots for session 1 and take a look.
% 
% The results can be loaded back into matlab using oat_load_results. 
% This is useful for checking over results of the GLM or as the basis for further analyses.

% Show OAT results
disp('oat.results:');
disp(oat.results);

%% VIEW THE GLM DESIGN MATRIX
%
% Running the OAT analysis will create an OAT output directory (whose name is the name set in oat.source_recon.dirname with a ?.oat? suffix added). This contains all you need to access the results of the analysis. It contains the analysis settings and the pointers to files containing the results for each of the pipeline stages that have been run. The oat can be loaded into Matlab with the call:
%
% |oat=osl_load_oat(oat.source_recon.dirname);|
%
% Each stage of the OAT pipeline will also have stored its results in a .mat 
% data file saved in the OAT output directory. Note that for source_recon and 
% first_level these are saved separately for each subject. The names of these 
% files are stored in the corresponding part of the OAT structure, e.g.
%
% * |oat.source_recon.results_fnames|
% * |oat.first_level.results_fnames|
% * |oat.subject_level.results_fnames|
% * |oat.group_level.results_fnames|
%
% These can loaded into Matlab, e.g. to load session 1?s source reconstruction results use the call:
%
% |recon_results= oat_load_results(oat,oat.source_recon.results_fnames{1})|
%
% E.g. to load session 2?s first level stats results, you can use the call:
% 
% |stats= oat_load_results(oat,oat.first_level.results_fnames{2})|
% 
% Run the following code to load in the stats results from the GLM you just ran and plot the design matrix.
% This is the nconditions by ntrials design matrix which is used to fit the GLM
% (NOTE that column 1 is motorbikes, columns 2-4 are faces)

% load first-level GLM result
stats1=oat_load_results(oat,oat.first_level.results_fnames{1});

% Plot design matrix
figure;imagesc(stats1.x);title('GLM design matrix');xlabel('regressor no.');ylabel('trial no.');

%% VISUALISE USING FIELDTRIP
% note that this produces an interactive figure, with which you can:
% * draw around a set of sensors
% * click in the drawn box to produce a plot of the time series
% * on the time series plot you can draw a time window
% * and click in the window to create a topoplot averaged over that time
% window (which is itself interactive....!)

S2=[];
S2.oat=oat;
S2.stats_fname=oat.first_level.results_fnames{1};
S2.modality='MEGPLANAR'; % can also set this to 'MEGMAG'
S2.first_level_contrast=[3]; % view faces-motorbikes contrast
S2.view_cope=1; % set to 0 to see the t-stat

% calculate t-stat using contrast of absolute value of parameter estimates
[cfg, dats, fig_handle]=oat_stats_multiplotER(S2);

##### SOURCE END #####
--></body></html>