---
layout: matlab_wrapper
title: HMM-MAR
resource: true
categories: examples
---

<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>HMM-MAR</title><meta name="generator" content="MATLAB 8.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-04-19"><meta name="DC.source" content="osl_example_hmmmar.m"></head><body><div class="content"><h1>HMM-MAR</h1><!--introduction--><p>This example shows how to use the HMM-MAR to infer transient states that: (i) are spectrally defined, i.e. the characteristics of interest are defined as a function of frequency. (ii) are based on the raw time series, i.e. we do not need to bandpass filter or compute power envelopes. (iii) are not only sensitive to power differences but also to phase coupling. The script infers a group (spectrally-defined) HMM from source space MEG data, following the paper Vidaurre et al, NeuroImage (2016)</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">1) HMM-MAR on hilbert envelopes</a></li><li><a href="#3">Loading and preparing the data</a></li><li><a href="#4">Prepare the HMM options and run the HMMMAR</a></li><li><a href="#5">Compute the spectral information of the states (power, coherence, etc)</a></li><li><a href="#6">2) HMM-MAR on raw signals</a></li><li><a href="#7">Loading and preparing the data</a></li><li><a href="#8">Signs might be arbitrarily flipped, so we need to disambiguate this</a></li><li><a href="#9">And run the HMM-MAR on this</a></li><li><a href="#10">Compute the spectral information of the states (power, coherence, etc)</a></li><li><a href="#11">Now we do some plotting of the HMM on power envelopes and HMM-MAR results</a></li><li><a href="#12">Now let's see the state evoked probability, locked to the stimulus</a></li><li><a href="#13">Show the spectral info (power and coherence) for the</a></li><li><a href="#14">HMM-based Time-frequency analysis</a></li><li><a href="#15">Probability of transit between states for the</a></li></ul></div><pre class="codeinput"><span class="comment">% Directory of the data:</span>
data_dir = fullfile(osldir,<span class="string">'example_data'</span>,<span class="string">'hmmmar_example'</span>);
<span class="comment">% Name for this HMM-MAR analysis:</span>
hmmmar_name = fullfile(osldir,<span class="string">'example_data'</span>,<span class="string">'hmmmar_example'</span>,<span class="string">'hmmmar_demo.mat'</span>);

<span class="comment">% Set |do_analysis=1| to re-run the analysis, otherwise use precomputed result</span>
do_analysis = 0;
</pre><h2 id="2">1) HMM-MAR on hilbert envelopes</h2><p>Such as in Baker et al, Elife (2014)</p><h2 id="3">Loading and preparing the data</h2><pre class="codeinput"><span class="comment">% We are going to concatenate data into a single matrix</span>
<span class="comment">% (if data is too big, the file names can also be provided to the hmmmar function)</span>
X = []; <span class="comment">% data, time by regions</span>
T = []; <span class="comment">% length of trials, a vector containing how long is each session/trial/subject</span>

subjects = [1 2 4 5 6 7 8 9]; <span class="comment">% index of the subjects</span>
N = length(subjects);

<span class="keyword">for</span> j = subjects <span class="comment">% iterate through subjects</span>
    file = fullfile(data_dir,[<span class="string">'sub'</span> num2str(j) <span class="string">'.mat'</span>]);
    load(file); <span class="comment">% load the data</span>
    sourcedata = sourcedata' ; <span class="comment">% we need it (time by channels)</span>
    T = [T size(sourcedata,1)]; <span class="comment">% time length of this subject</span>
    <span class="keyword">for</span> i=1:size(sourcedata,2)
        sourcedata(:,i) = abs(hilbert(sourcedata(:,i))); <span class="comment">% Hilbert envelope</span>
    <span class="keyword">end</span>
    sourcedata = zscore(sourcedata); <span class="comment">% standardize subject such that it has mean 0 and stdev 1</span>
    X = [X; sourcedata]; <span class="comment">% concat subject</span>
<span class="keyword">end</span>
</pre><h2 id="4">Prepare the HMM options and run the HMMMAR</h2><pre class="codeinput">options = struct();
options.K = 3; <span class="comment">% number of states</span>
options.order =  0; <span class="comment">% order 0 means a Gaussian distribution (adequate for power time series)</span>
options.covtype = <span class="string">'full'</span>;
<span class="comment">% model connectivity, covtype='full' means that we model the covariance between regions</span>
options.zeromean = 0;
<span class="comment">% zeromean=0 means that we model the mean, i.e. model the "amount of power"</span>
<span class="comment">% zeromean=1 means that we do *not* model the mean</span>
options.cyc = 100;
options.initcyc = 10;
options.initrep = 3;
options.verbose = 1; <span class="comment">% show progress?</span>
<span class="keyword">if</span> do_analysis
    [hmm_env,Gamma_env] = hmmmar(X,T,options);
<span class="keyword">else</span>
    load(hmmmar_name,<span class="string">'hmm_env'</span>,<span class="string">'Gamma_env'</span>)
<span class="keyword">end</span>
</pre><h2 id="5">Compute the spectral information of the states (power, coherence, etc)</h2><p>using a weighted version of the multitaper Note that we can't get an estimation of the spectra directly from the parameters in this case, as the HMM has been run in wideband power time series</p><pre class="codeinput">options = struct();
options.fpass = [1 40]; <span class="comment">% frequency range we want to look at</span>
options.tapers = [4 7]; <span class="comment">% internal multitaper parameter</span>
options.Fs = 200; <span class="comment">% sampling frequency in hertzs</span>
options.win = 10 * options.Fs; <span class="comment">% window, related to the level of detail in frequency of the estimation</span>

<span class="keyword">if</span> do_analysis
    spectra_env = hmmspectramt(X,T,Gamma_env,options);
<span class="keyword">else</span>
    load(hmmmar_name,<span class="string">'spectra_env'</span>)
<span class="keyword">end</span>
</pre><h2 id="6">2) HMM-MAR on raw signals</h2><p>Such as in Vidaurre et al, NeuroImage (2016)</p><h2 id="7">Loading and preparing the data</h2><pre class="codeinput"><span class="comment">% We are going to concatenate data into a single matrix</span>
<span class="comment">% (if data is too big, the file names can also be provided to the hmmmar function)</span>
X = []; <span class="comment">% data, time by regions</span>
T = []; <span class="comment">% length of trials, a vector containing how long is each session/trial/subject</span>

subjects = [1 2 4 5 6 7 8 9]; <span class="comment">% index of the subjects</span>
N = length(subjects);

<span class="keyword">for</span> j = subjects <span class="comment">% iterate through subjects</span>
    file = fullfile(data_dir,[<span class="string">'sub'</span> num2str(j) <span class="string">'.mat'</span>]);
    load(file); <span class="comment">% load the data</span>
    sourcedata = sourcedata' ; <span class="comment">% we need it (time by channels)</span>
    T = [T size(sourcedata,1)]; <span class="comment">% time length of this subject</span>
    sourcedata = zscore(sourcedata); <span class="comment">% standardize subject such that it has mean 0 and stdev 1</span>
    X = [X; sourcedata]; <span class="comment">% concat subject</span>
<span class="keyword">end</span>
</pre><h2 id="8">Signs might be arbitrarily flipped, so we need to disambiguate this</h2><p>this is because the intrinsic ambiguity in source-reconstructed signals</p><pre class="codeinput">options = struct();
options.maxlag = 8;
options.noruns = 100;

[flips,scorepath] = findflip(X,T,options);
X = flipdata(X,T,flips);
</pre><pre class="">Run 1, Init, score 1.803856 
Run 1, Cycle 1, score +0.484205, flipped (5,1) 
Run 1, Cycle 2, score +0.128253, flipped (2,1) 
Run 1, Cycle 3, score +0
Run 1, Cycle 4, score +0
Run 1, Cycle 5, score +0
Run 1, Cycle 6, score +0
Run 1, Cycle 7, score +0
Run 1, Cycle 8, score +0
Run 1, Cycle 9, score +0
Convergence, score=2.416314 
Run 2, Init, score 1.078799 
Run 2, Cycle 1, score +0.809976, flipped (7,1) 
Run 2, Cycle 2, score +0.226747, flipped (3,1) 
Run 2, Cycle 3, score +0.212811, flipped (6,1) 
Run 2, Cycle 4, score +0.087981, flipped (8,1) 
Run 2, Cycle 5, score +0
Run 2, Cycle 6, score +0
Run 2, Cycle 7, score +0
Run 2, Cycle 8, score +0
Run 2, Cycle 9, score +0
Convergence, score=2.416314 
Run 3, Init, score 0.961397 
Run 3, Cycle 1, score +1.326664, flipped (7,1) 
Run 3, Cycle 2, score +0.128253, flipped (2,1) 
Run 3, Cycle 3, score +0
Run 3, Cycle 4, score +0
Run 3, Cycle 5, score +0
Run 3, Cycle 6, score +0
Run 3, Cycle 7, score +0
Run 3, Cycle 8, score +0
Run 3, Cycle 9, score +0
Convergence, score=2.416314 
Run 4, Init, score 0.850912 
Run 4, Cycle 1, score +0.884314, flipped (7,1) 
Run 4, Cycle 2, score +0.477826, flipped (5,1) 
Run 4, Cycle 3, score +0.203262, flipped (1,1) 
Run 4, Cycle 4, score +0
Run 4, Cycle 5, score +0
Run 4, Cycle 6, score +0
Run 4, Cycle 7, score +0
Run 4, Cycle 8, score +0
Run 4, Cycle 9, score +0
Convergence, score=2.416314 
Run 5, Init, score 1.348806 
Run 5, Cycle 1, score +0.676692, flipped (5,1) 
Run 5, Cycle 2, score +0.194492, flipped (6,1) 
Run 5, Cycle 3, score +0.108343, flipped (2,1) 
Run 5, Cycle 4, score +0.087981, flipped (8,1) 
Run 5, Cycle 5, score +0
Run 5, Cycle 6, score +0
Run 5, Cycle 7, score +0
Run 5, Cycle 8, score +0
Run 5, Cycle 9, score +0
Convergence, score=2.416314 
Run 6, Init, score 2.001942 
Run 6, Cycle 1, score +0.286119, flipped (6,1) 
Run 6, Cycle 2, score +0.128253, flipped (2,1) 
Run 6, Cycle 3, score +0
Run 6, Cycle 4, score +0
Run 6, Cycle 5, score +0
Run 6, Cycle 6, score +0
Run 6, Cycle 7, score +0
Run 6, Cycle 8, score +0
Run 6, Cycle 9, score +0
Convergence, score=2.416314 
Run 7, Init, score 0.910688 
Run 7, Cycle 1, score +1.204835, flipped (7,1) 
Run 7, Cycle 2, score +0.212811, flipped (6,1) 
Run 7, Cycle 3, score +0.087981, flipped (8,1) 
Run 7, Cycle 4, score +0
Run 7, Cycle 5, score +0
Run 7, Cycle 6, score +0
Run 7, Cycle 7, score +0
Run 7, Cycle 8, score +0
Run 7, Cycle 9, score +0
Convergence, score=2.416314 
Run 8, Init, score 1.085290 
Run 8, Cycle 1, score +0.717838, flipped (5,1) 
Run 8, Cycle 2, score +0.211006, flipped (2,1) 
Run 8, Cycle 3, score +0.080315, flipped (3,1) 
Run 8, Cycle 4, score +0.233883, flipped (1,1) 
Run 8, Cycle 5, score +0.087981, flipped (8,1) 
Run 8, Cycle 6, score +0
Run 8, Cycle 7, score +0
Run 8, Cycle 8, score +0
Run 8, Cycle 9, score +0
Convergence, score=2.416314 
Run 9, Init, score 0.941540 
Run 9, Cycle 1, score +0.949002, flipped (4,1) 
Run 9, Cycle 2, score +0.437791, flipped (3,1) 
Run 9, Cycle 3, score +0.087981, flipped (8,1) 
Run 9, Cycle 4, score +0
Run 9, Cycle 5, score +0
Run 9, Cycle 6, score +0
Run 9, Cycle 7, score +0
Run 9, Cycle 8, score +0
Run 9, Cycle 9, score +0
Convergence, score=2.416314 
Run 10, Init, score 0.839457 
Run 10, Cycle 1, score +1.103117, flipped (4,1) 
Run 10, Cycle 2, score +0.473740, flipped (5,1) 
Run 10, Cycle 3, score +0
Run 10, Cycle 4, score +0
Run 10, Cycle 5, score +0
Run 10, Cycle 6, score +0
Run 10, Cycle 7, score +0
Run 10, Cycle 8, score +0
Run 10, Cycle 9, score +0
Convergence, score=2.416314 
Run 11, Init, score 1.803856 
Run 11, Cycle 1, score +0.484205, flipped (5,1) 
Run 11, Cycle 2, score +0.128253, flipped (2,1) 
Run 11, Cycle 3, score +0
Run 11, Cycle 4, score +0
Run 11, Cycle 5, score +0
Run 11, Cycle 6, score +0
Run 11, Cycle 7, score +0
Run 11, Cycle 8, score +0
Run 11, Cycle 9, score +0
Convergence, score=2.416314 
Run 12, Init, score 1.803128 
Run 12, Cycle 1, score +0.211006, flipped (2,1) 
Run 12, Cycle 2, score +0.080315, flipped (3,1) 
Run 12, Cycle 3, score +0.233883, flipped (1,1) 
Run 12, Cycle 4, score +0.087981, flipped (8,1) 
Run 12, Cycle 5, score +0
Run 12, Cycle 6, score +0
Run 12, Cycle 7, score +0
Run 12, Cycle 8, score +0
Run 12, Cycle 9, score +0
Convergence, score=2.416314 
Run 13, Init, score 0.597673 
Run 13, Cycle 1, score +1.056669, flipped (4,1) 
Run 13, Cycle 2, score +0.435610, flipped (3,1) 
Run 13, Cycle 3, score +0.198109, flipped (1,1) 
Run 13, Cycle 4, score +0.128253, flipped (2,1) 
Run 13, Cycle 5, score +0
Run 13, Cycle 6, score +0
Run 13, Cycle 7, score +0
Run 13, Cycle 8, score +0
Run 13, Cycle 9, score +0
Convergence, score=2.416314 
Run 14, Init, score 0.910688 
Run 14, Cycle 1, score +1.204835, flipped (7,1) 
Run 14, Cycle 2, score +0.212811, flipped (6,1) 
Run 14, Cycle 3, score +0.087981, flipped (8,1) 
Run 14, Cycle 4, score +0
Run 14, Cycle 5, score +0
Run 14, Cycle 6, score +0
Run 14, Cycle 7, score +0
Run 14, Cycle 8, score +0
Run 14, Cycle 9, score +0
Convergence, score=2.416314 
Run 15, Init, score 1.735226 
Run 15, Cycle 1, score +0.477826, flipped (5,1) 
Run 15, Cycle 2, score +0.203262, flipped (1,1) 
Run 15, Cycle 3, score +0
Run 15, Cycle 4, score +0
Run 15, Cycle 5, score +0
Run 15, Cycle 6, score +0
Run 15, Cycle 7, score +0
Run 15, Cycle 8, score +0
Run 15, Cycle 9, score +0
Convergence, score=2.416314 
Run 16, Init, score 1.335315 
Run 16, Cycle 1, score +0.620677, flipped (5,1) 
Run 16, Cycle 2, score +0.159530, flipped (1,1) 
Run 16, Cycle 3, score +0.212811, flipped (6,1) 
Run 16, Cycle 4, score +0.087981, flipped (8,1) 
Run 16, Cycle 5, score +0
Run 16, Cycle 6, score +0
Run 16, Cycle 7, score +0
Run 16, Cycle 8, score +0
Run 16, Cycle 9, score +0
Convergence, score=2.416314 
Run 17, Init, score 0.757912 
Run 17, Cycle 1, score +1.198080, flipped (7,1) 
Run 17, Cycle 2, score +0.159530, flipped (1,1) 
Run 17, Cycle 3, score +0.212811, flipped (6,1) 
Run 17, Cycle 4, score +0.087981, flipped (8,1) 
Run 17, Cycle 5, score +0
Run 17, Cycle 6, score +0
Run 17, Cycle 7, score +0
Run 17, Cycle 8, score +0
Run 17, Cycle 9, score +0
Convergence, score=2.416314 
Run 18, Init, score 1.785116 
Run 18, Cycle 1, score +0.211006, flipped (2,1) 
Run 18, Cycle 2, score +0.018012, flipped (6,1) 
Run 18, Cycle 3, score +0.080315, flipped (3,1) 
Run 18, Cycle 4, score +0.233883, flipped (1,1) 
Run 18, Cycle 5, score +0.087981, flipped (8,1) 
Run 18, Cycle 6, score +0
Run 18, Cycle 7, score +0
Run 18, Cycle 8, score +0
Run 18, Cycle 9, score +0
Convergence, score=2.416314 
Run 19, Init, score 1.745523 
Run 19, Cycle 1, score +0.474467, flipped (3,1) 
Run 19, Cycle 2, score +0.108343, flipped (2,1) 
Run 19, Cycle 3, score +0.087981, flipped (8,1) 
Run 19, Cycle 4, score +0
Run 19, Cycle 5, score +0
Run 19, Cycle 6, score +0
Run 19, Cycle 7, score +0
Run 19, Cycle 8, score +0
Run 19, Cycle 9, score +0
Convergence, score=2.416314 
Run 20, Init, score 1.308615 
Run 20, Cycle 1, score +0.581927, flipped (5,1) 
Run 20, Cycle 2, score +0.437791, flipped (3,1) 
Run 20, Cycle 3, score +0.087981, flipped (8,1) 
Run 20, Cycle 4, score +0
Run 20, Cycle 5, score +0
Run 20, Cycle 6, score +0
Run 20, Cycle 7, score +0
Run 20, Cycle 8, score +0
Run 20, Cycle 9, score +0
Convergence, score=2.416314 
Run 21, Init, score 1.060020 
Run 21, Cycle 1, score +1.055503, flipped (4,1) 
Run 21, Cycle 2, score +0.212811, flipped (6,1) 
Run 21, Cycle 3, score +0.087981, flipped (8,1) 
Run 21, Cycle 4, score +0
Run 21, Cycle 5, score +0
Run 21, Cycle 6, score +0
Run 21, Cycle 7, score +0
Run 21, Cycle 8, score +0
Run 21, Cycle 9, score +0
Convergence, score=2.416314 
Run 22, Init, score 1.348806 
Run 22, Cycle 1, score +0.676692, flipped (5,1) 
Run 22, Cycle 2, score +0.194492, flipped (6,1) 
Run 22, Cycle 3, score +0.108343, flipped (2,1) 
Run 22, Cycle 4, score +0.087981, flipped (8,1) 
Run 22, Cycle 5, score +0
Run 22, Cycle 6, score +0
Run 22, Cycle 7, score +0
Run 22, Cycle 8, score +0
Run 22, Cycle 9, score +0
Convergence, score=2.416314 
Run 23, Init, score 1.251333 
Run 23, Cycle 1, score +0.565510, flipped (5,1) 
Run 23, Cycle 2, score +0.273109, flipped (6,1) 
Run 23, Cycle 3, score +0.198109, flipped (1,1) 
Run 23, Cycle 4, score +0.128253, flipped (2,1) 
Run 23, Cycle 5, score +0
Run 23, Cycle 6, score +0
Run 23, Cycle 7, score +0
Run 23, Cycle 8, score +0
Run 23, Cycle 9, score +0
Convergence, score=2.416314 
Run 24, Init, score 2.115522 
Run 24, Cycle 1, score +0.212811, flipped (6,1) 
Run 24, Cycle 2, score +0.087981, flipped (8,1) 
Run 24, Cycle 3, score +0
Run 24, Cycle 4, score +0
Run 24, Cycle 5, score +0
Run 24, Cycle 6, score +0
Run 24, Cycle 7, score +0
Run 24, Cycle 8, score +0
Run 24, Cycle 9, score +0
Convergence, score=2.416314 
Run 25, Init, score 0.854354 
Run 25, Cycle 1, score +1.235597, flipped (7,1) 
Run 25, Cycle 2, score +0.198109, flipped (1,1) 
Run 25, Cycle 3, score +0.128253, flipped (2,1) 
Run 25, Cycle 4, score +0
Run 25, Cycle 5, score +0
Run 25, Cycle 6, score +0
Run 25, Cycle 7, score +0
Run 25, Cycle 8, score +0
Run 25, Cycle 9, score +0
Convergence, score=2.416314 
Run 26, Init, score 1.052163 
Run 26, Cycle 1, score +0.836612, flipped (4,1) 
Run 26, Cycle 2, score +0.226747, flipped (3,1) 
Run 26, Cycle 3, score +0.212811, flipped (6,1) 
Run 26, Cycle 4, score +0.087981, flipped (8,1) 
Run 26, Cycle 5, score +0
Run 26, Cycle 6, score +0
Run 26, Cycle 7, score +0
Run 26, Cycle 8, score +0
Run 26, Cycle 9, score +0
Convergence, score=2.416314 
Run 27, Init, score 2.213052 
Run 27, Cycle 1, score +0.203262, flipped (1,1) 
Run 27, Cycle 2, score +0
Run 27, Cycle 3, score +0
Run 27, Cycle 4, score +0
Run 27, Cycle 5, score +0
Run 27, Cycle 6, score +0
Run 27, Cycle 7, score +0
Run 27, Cycle 8, score +0
Run 27, Cycle 9, score +0
Convergence, score=2.416314 
Run 28, Init, score 0.556344 
Run 28, Cycle 1, score +1.160652, flipped (4,1) 
Run 28, Cycle 2, score +0.279126, flipped (8,1) 
Run 28, Cycle 3, score +0.018012, flipped (6,1) 
Run 28, Cycle 4, score +0.080315, flipped (3,1) 
Run 28, Cycle 5, score +0.233883, flipped (1,1) 
Run 28, Cycle 6, score +0.087981, flipped (8,1) 
Run 28, Cycle 7, score +0
Run 28, Cycle 8, score +0
Run 28, Cycle 9, score +0
Convergence, score=2.416314 
Run 29, Init, score 0.910688 
Run 29, Cycle 1, score +1.204835, flipped (7,1) 
Run 29, Cycle 2, score +0.212811, flipped (6,1) 
Run 29, Cycle 3, score +0.087981, flipped (8,1) 
Run 29, Cycle 4, score +0
Run 29, Cycle 5, score +0
Run 29, Cycle 6, score +0
Run 29, Cycle 7, score +0
Run 29, Cycle 8, score +0
Run 29, Cycle 9, score +0
Convergence, score=2.416314 
Run 30, Init, score 1.084411 
Run 30, Cycle 1, score +0.911712, flipped (4,1) 
Run 30, Cycle 2, score +0.018012, flipped (6,1) 
Run 30, Cycle 3, score +0.080315, flipped (3,1) 
Run 30, Cycle 4, score +0.233883, flipped (1,1) 
Run 30, Cycle 5, score +0.087981, flipped (8,1) 
Run 30, Cycle 6, score +0
Run 30, Cycle 7, score +0
Run 30, Cycle 8, score +0
Run 30, Cycle 9, score +0
Convergence, score=2.416314 
Run 31, Init, score 1.475385 
Run 31, Cycle 1, score +0.526557, flipped (5,1) 
Run 31, Cycle 2, score +0.286119, flipped (6,1) 
Run 31, Cycle 3, score +0.128253, flipped (2,1) 
Run 31, Cycle 4, score +0
Run 31, Cycle 5, score +0
Run 31, Cycle 6, score +0
Run 31, Cycle 7, score +0
Run 31, Cycle 8, score +0
Run 31, Cycle 9, score +0
Convergence, score=2.416314 
Run 32, Init, score 0.451356 
Run 32, Cycle 1, score +1.133797, flipped (7,1) 
Run 32, Cycle 2, score +0.509297, flipped (5,1) 
Run 32, Cycle 3, score +0.233883, flipped (1,1) 
Run 32, Cycle 4, score +0.087981, flipped (8,1) 
Run 32, Cycle 5, score +0
Run 32, Cycle 6, score +0
Run 32, Cycle 7, score +0
Run 32, Cycle 8, score +0
Run 32, Cycle 9, score +0
Convergence, score=2.416314 
Run 33, Init, score 0.628563 
Run 33, Cycle 1, score +1.193293, flipped (4,1) 
Run 33, Cycle 2, score +0.391196, flipped (3,1) 
Run 33, Cycle 3, score +0.203262, flipped (1,1) 
Run 33, Cycle 4, score +0
Run 33, Cycle 5, score +0
Run 33, Cycle 6, score +0
Run 33, Cycle 7, score +0
Run 33, Cycle 8, score +0
Run 33, Cycle 9, score +0
Convergence, score=2.416314 
Run 34, Init, score 1.348806 
Run 34, Cycle 1, score +0.676692, flipped (5,1) 
Run 34, Cycle 2, score +0.194492, flipped (6,1) 
Run 34, Cycle 3, score +0.108343, flipped (2,1) 
Run 34, Cycle 4, score +0.087981, flipped (8,1) 
Run 34, Cycle 5, score +0
Run 34, Cycle 6, score +0
Run 34, Cycle 7, score +0
Run 34, Cycle 8, score +0
Run 34, Cycle 9, score +0
Convergence, score=2.416314 
Run 35, Init, score 2.288061 
Run 35, Cycle 1, score +0.128253, flipped (2,1) 
Run 35, Cycle 2, score +0
Run 35, Cycle 3, score +0
Run 35, Cycle 4, score +0
Run 35, Cycle 5, score +0
Run 35, Cycle 6, score +0
Run 35, Cycle 7, score +0
Run 35, Cycle 8, score +0
Run 35, Cycle 9, score +0
Convergence, score=2.416314 
Run 36, Init, score 1.221498 
Run 36, Cycle 1, score +0.667277, flipped (5,1) 
Run 36, Cycle 2, score +0.226747, flipped (3,1) 
Run 36, Cycle 3, score +0.212811, flipped (6,1) 
Run 36, Cycle 4, score +0.087981, flipped (8,1) 
Run 36, Cycle 5, score +0
Run 36, Cycle 6, score +0
Run 36, Cycle 7, score +0
Run 36, Cycle 8, score +0
Run 36, Cycle 9, score +0
Convergence, score=2.416314 
Run 37, Init, score 0.996748 
Run 37, Cycle 1, score +1.216304, flipped (4,1) 
Run 37, Cycle 2, score +0.203262, flipped (1,1) 
Run 37, Cycle 3, score +0
Run 37, Cycle 4, score +0
Run 37, Cycle 5, score +0
Run 37, Cycle 6, score +0
Run 37, Cycle 7, score +0
Run 37, Cycle 8, score +0
Run 37, Cycle 9, score +0
Convergence, score=2.416314 
Run 38, Init, score 1.084411 
Run 38, Cycle 1, score +0.911712, flipped (4,1) 
Run 38, Cycle 2, score +0.018012, flipped (6,1) 
Run 38, Cycle 3, score +0.080315, flipped (3,1) 
Run 38, Cycle 4, score +0.233883, flipped (1,1) 
Run 38, Cycle 5, score +0.087981, flipped (8,1) 
Run 38, Cycle 6, score +0
Run 38, Cycle 7, score +0
Run 38, Cycle 8, score +0
Run 38, Cycle 9, score +0
Convergence, score=2.416314 
Run 39, Init, score 1.221498 
Run 39, Cycle 1, score +0.667277, flipped (5,1) 
Run 39, Cycle 2, score +0.226747, flipped (3,1) 
Run 39, Cycle 3, score +0.212811, flipped (6,1) 
Run 39, Cycle 4, score +0.087981, flipped (8,1) 
Run 39, Cycle 5, score +0
Run 39, Cycle 6, score +0
Run 39, Cycle 7, score +0
Run 39, Cycle 8, score +0
Run 39, Cycle 9, score +0
Convergence, score=2.416314 
Run 40, Init, score 0.475000 
Run 40, Cycle 1, score +1.335988, flipped (7,1) 
Run 40, Cycle 2, score +0.605325, flipped (3,1) 
Run 40, Cycle 3, score +0
Run 40, Cycle 4, score +0
Run 40, Cycle 5, score +0
Run 40, Cycle 6, score +0
Run 40, Cycle 7, score +0
Run 40, Cycle 8, score +0
Run 40, Cycle 9, score +0
Convergence, score=2.416314 
Run 41, Init, score 0.951265 
Run 41, Cycle 1, score +1.062869, flipped (4,1) 
Run 41, Cycle 2, score +0.080315, flipped (3,1) 
Run 41, Cycle 3, score +0.233883, flipped (1,1) 
Run 41, Cycle 4, score +0.087981, flipped (8,1) 
Run 41, Cycle 5, score +0
Run 41, Cycle 6, score +0
Run 41, Cycle 7, score +0
Run 41, Cycle 8, score +0
Run 41, Cycle 9, score +0
Convergence, score=2.416314 
Run 42, Init, score 1.888775 
Run 42, Cycle 1, score +0.226747, flipped (3,1) 
Run 42, Cycle 2, score +0.212811, flipped (6,1) 
Run 42, Cycle 3, score +0.087981, flipped (8,1) 
Run 42, Cycle 4, score +0
Run 42, Cycle 5, score +0
Run 42, Cycle 6, score +0
Run 42, Cycle 7, score +0
Run 42, Cycle 8, score +0
Run 42, Cycle 9, score +0
Convergence, score=2.416314 
Run 43, Init, score 0.551302 
Run 43, Cycle 1, score +1.144787, flipped (4,1) 
Run 43, Cycle 2, score +0.591972, flipped (3,1) 
Run 43, Cycle 3, score +0.128253, flipped (2,1) 
Run 43, Cycle 4, score +0
Run 43, Cycle 5, score +0
Run 43, Cycle 6, score +0
Run 43, Cycle 7, score +0
Run 43, Cycle 8, score +0
Run 43, Cycle 9, score +0
Convergence, score=2.416314 
Run 44, Init, score 0.704044 
Run 44, Cycle 1, score +1.099084, flipped (4,1) 
Run 44, Cycle 2, score +0.211006, flipped (2,1) 
Run 44, Cycle 3, score +0.080315, flipped (3,1) 
Run 44, Cycle 4, score +0.233883, flipped (1,1) 
Run 44, Cycle 5, score +0.087981, flipped (8,1) 
Run 44, Cycle 6, score +0
Run 44, Cycle 7, score +0
Run 44, Cycle 8, score +0
Run 44, Cycle 9, score +0
Convergence, score=2.416314 
Run 45, Init, score 1.411533 
Run 45, Cycle 1, score +0.562517, flipped (5,1) 
Run 45, Cycle 2, score +0.245940, flipped (1,1) 
Run 45, Cycle 3, score +0.108343, flipped (2,1) 
Run 45, Cycle 4, score +0.087981, flipped (8,1) 
Run 45, Cycle 5, score +0
Run 45, Cycle 6, score +0
Run 45, Cycle 7, score +0
Run 45, Cycle 8, score +0
Run 45, Cycle 9, score +0
Convergence, score=2.416314 
Run 46, Init, score 1.745523 
Run 46, Cycle 1, score +0.474467, flipped (3,1) 
Run 46, Cycle 2, score +0.108343, flipped (2,1) 
Run 46, Cycle 3, score +0.087981, flipped (8,1) 
Run 46, Cycle 4, score +0
Run 46, Cycle 5, score +0
Run 46, Cycle 6, score +0
Run 46, Cycle 7, score +0
Run 46, Cycle 8, score +0
Run 46, Cycle 9, score +0
Convergence, score=2.416314 
Run 47, Init, score 1.085290 
Run 47, Cycle 1, score +0.717838, flipped (5,1) 
Run 47, Cycle 2, score +0.211006, flipped (2,1) 
Run 47, Cycle 3, score +0.080315, flipped (3,1) 
Run 47, Cycle 4, score +0.233883, flipped (1,1) 
Run 47, Cycle 5, score +0.087981, flipped (8,1) 
Run 47, Cycle 6, score +0
Run 47, Cycle 7, score +0
Run 47, Cycle 8, score +0
Run 47, Cycle 9, score +0
Convergence, score=2.416314 
Run 48, Init, score 0.728541 
Run 48, Cycle 1, score +1.088302, flipped (4,1) 
Run 48, Cycle 2, score +0.273109, flipped (6,1) 
Run 48, Cycle 3, score +0.198109, flipped (1,1) 
Run 48, Cycle 4, score +0.128253, flipped (2,1) 
Run 48, Cycle 5, score +0
Run 48, Cycle 6, score +0
Run 48, Cycle 7, score +0
Run 48, Cycle 8, score +0
Run 48, Cycle 9, score +0
Convergence, score=2.416314 
Run 49, Init, score 1.511337 
Run 49, Cycle 1, score +0.490606, flipped (3,1) 
Run 49, Cycle 2, score +0.286119, flipped (6,1) 
Run 49, Cycle 3, score +0.128253, flipped (2,1) 
Run 49, Cycle 4, score +0
Run 49, Cycle 5, score +0
Run 49, Cycle 6, score +0
Run 49, Cycle 7, score +0
Run 49, Cycle 8, score +0
Run 49, Cycle 9, score +0
Convergence, score=2.416314 
Run 50, Init, score 2.001942 
Run 50, Cycle 1, score +0.286119, flipped (6,1) 
Run 50, Cycle 2, score +0.128253, flipped (2,1) 
Run 50, Cycle 3, score +0
Run 50, Cycle 4, score +0
Run 50, Cycle 5, score +0
Run 50, Cycle 6, score +0
Run 50, Cycle 7, score +0
Run 50, Cycle 8, score +0
Run 50, Cycle 9, score +0
Convergence, score=2.416314 
Run 51, Init, score 1.113547 
Run 51, Cycle 1, score +0.695482, flipped (5,1) 
Run 51, Cycle 2, score +0.216468, flipped (1,1) 
Run 51, Cycle 3, score +0.194492, flipped (6,1) 
Run 51, Cycle 4, score +0.108343, flipped (2,1) 
Run 51, Cycle 5, score +0.087981, flipped (8,1) 
Run 51, Cycle 6, score +0
Run 51, Cycle 7, score +0
Run 51, Cycle 8, score +0
Run 51, Cycle 9, score +0
Convergence, score=2.416314 
Run 52, Init, score 2.416314 
Run 52, Cycle 1, score +0
Run 52, Cycle 2, score +0
Run 52, Cycle 3, score +0
Run 52, Cycle 4, score +0
Run 52, Cycle 5, score +0
Run 52, Cycle 6, score +0
Run 52, Cycle 7, score +0
Run 52, Cycle 8, score +0
Run 52, Cycle 9, score +0
Convergence, score=2.416314 
Run 53, Init, score 0.587931 
Run 53, Cycle 1, score +1.346726, flipped (7,1) 
Run 53, Cycle 2, score +0.278396, flipped (6,1) 
Run 53, Cycle 3, score +0.203262, flipped (1,1) 
Run 53, Cycle 4, score +0
Run 53, Cycle 5, score +0
Run 53, Cycle 6, score +0
Run 53, Cycle 7, score +0
Run 53, Cycle 8, score +0
Run 53, Cycle 9, score +0
Convergence, score=2.416314 
Run 54, Init, score 0.573057 
Run 54, Cycle 1, score +1.214176, flipped (7,1) 
Run 54, Cycle 2, score +0.541099, flipped (5,1) 
Run 54, Cycle 3, score +0.087981, flipped (8,1) 
Run 54, Cycle 4, score +0
Run 54, Cycle 5, score +0
Run 54, Cycle 6, score +0
Run 54, Cycle 7, score +0
Run 54, Cycle 8, score +0
Run 54, Cycle 9, score +0
Convergence, score=2.416314 
Run 55, Init, score 1.348806 
Run 55, Cycle 1, score +0.676692, flipped (5,1) 
Run 55, Cycle 2, score +0.194492, flipped (6,1) 
Run 55, Cycle 3, score +0.108343, flipped (2,1) 
Run 55, Cycle 4, score +0.087981, flipped (8,1) 
Run 55, Cycle 5, score +0
Run 55, Cycle 6, score +0
Run 55, Cycle 7, score +0
Run 55, Cycle 8, score +0
Run 55, Cycle 9, score +0
Convergence, score=2.416314 
Run 56, Init, score 1.803856 
Run 56, Cycle 1, score +0.484205, flipped (5,1) 
Run 56, Cycle 2, score +0.128253, flipped (2,1) 
Run 56, Cycle 3, score +0
Run 56, Cycle 4, score +0
Run 56, Cycle 5, score +0
Run 56, Cycle 6, score +0
Run 56, Cycle 7, score +0
Run 56, Cycle 8, score +0
Run 56, Cycle 9, score +0
Convergence, score=2.416314 
Run 57, Init, score 0.451356 
Run 57, Cycle 1, score +1.133797, flipped (7,1) 
Run 57, Cycle 2, score +0.509297, flipped (5,1) 
Run 57, Cycle 3, score +0.233883, flipped (1,1) 
Run 57, Cycle 4, score +0.087981, flipped (8,1) 
Run 57, Cycle 5, score +0
Run 57, Cycle 6, score +0
Run 57, Cycle 7, score +0
Run 57, Cycle 8, score +0
Run 57, Cycle 9, score +0
Convergence, score=2.416314 
Run 58, Init, score 0.467071 
Run 58, Cycle 1, score +1.167960, flipped (4,1) 
Run 58, Cycle 2, score +0.476804, flipped (3,1) 
Run 58, Cycle 3, score +0.304479, flipped (6,1) 
Run 58, Cycle 4, score +0
Run 58, Cycle 5, score +0
Run 58, Cycle 6, score +0
Run 58, Cycle 7, score +0
Run 58, Cycle 8, score +0
Run 58, Cycle 9, score +0
Convergence, score=2.416314 
Run 59, Init, score 1.060020 
Run 59, Cycle 1, score +1.055503, flipped (4,1) 
Run 59, Cycle 2, score +0.212811, flipped (6,1) 
Run 59, Cycle 3, score +0.087981, flipped (8,1) 
Run 59, Cycle 4, score +0
Run 59, Cycle 5, score +0
Run 59, Cycle 6, score +0
Run 59, Cycle 7, score +0
Run 59, Cycle 8, score +0
Run 59, Cycle 9, score +0
Convergence, score=2.416314 
Run 60, Init, score 1.942574 
Run 60, Cycle 1, score +0.473740, flipped (5,1) 
Run 60, Cycle 2, score +0
Run 60, Cycle 3, score +0
Run 60, Cycle 4, score +0
Run 60, Cycle 5, score +0
Run 60, Cycle 6, score +0
Run 60, Cycle 7, score +0
Run 60, Cycle 8, score +0
Run 60, Cycle 9, score +0
Convergence, score=2.416314 
Run 61, Init, score 0.725668 
Run 61, Cycle 1, score +1.487384, flipped (7,1) 
Run 61, Cycle 2, score +0.203262, flipped (1,1) 
Run 61, Cycle 3, score +0
Run 61, Cycle 4, score +0
Run 61, Cycle 5, score +0
Run 61, Cycle 6, score +0
Run 61, Cycle 7, score +0
Run 61, Cycle 8, score +0
Run 61, Cycle 9, score +0
Convergence, score=2.416314 
Run 62, Init, score 0.587931 
Run 62, Cycle 1, score +1.346726, flipped (7,1) 
Run 62, Cycle 2, score +0.278396, flipped (6,1) 
Run 62, Cycle 3, score +0.203262, flipped (1,1) 
Run 62, Cycle 4, score +0
Run 62, Cycle 5, score +0
Run 62, Cycle 6, score +0
Run 62, Cycle 7, score +0
Run 62, Cycle 8, score +0
Run 62, Cycle 9, score +0
Convergence, score=2.416314 
Run 63, Init, score 1.308615 
Run 63, Cycle 1, score +0.581927, flipped (5,1) 
Run 63, Cycle 2, score +0.437791, flipped (3,1) 
Run 63, Cycle 3, score +0.087981, flipped (8,1) 
Run 63, Cycle 4, score +0
Run 63, Cycle 5, score +0
Run 63, Cycle 6, score +0
Run 63, Cycle 7, score +0
Run 63, Cycle 8, score +0
Run 63, Cycle 9, score +0
Convergence, score=2.416314 
Run 64, Init, score 0.668972 
Run 64, Cycle 1, score +1.134157, flipped (7,1) 
Run 64, Cycle 2, score +0.211006, flipped (2,1) 
Run 64, Cycle 3, score +0.080315, flipped (3,1) 
Run 64, Cycle 4, score +0.233883, flipped (1,1) 
Run 64, Cycle 5, score +0.087981, flipped (8,1) 
Run 64, Cycle 6, score +0
Run 64, Cycle 7, score +0
Run 64, Cycle 8, score +0
Run 64, Cycle 9, score +0
Convergence, score=2.416314 
Run 65, Init, score 0.573057 
Run 65, Cycle 1, score +1.214176, flipped (7,1) 
Run 65, Cycle 2, score +0.541099, flipped (5,1) 
Run 65, Cycle 3, score +0.087981, flipped (8,1) 
Run 65, Cycle 4, score +0
Run 65, Cycle 5, score +0
Run 65, Cycle 6, score +0
Run 65, Cycle 7, score +0
Run 65, Cycle 8, score +0
Run 65, Cycle 9, score +0
Convergence, score=2.416314 
Run 66, Init, score 1.252448 
Run 66, Cycle 1, score +0.569408, flipped (5,1) 
Run 66, Cycle 2, score +0.391196, flipped (3,1) 
Run 66, Cycle 3, score +0.203262, flipped (1,1) 
Run 66, Cycle 4, score +0
Run 66, Cycle 5, score +0
Run 66, Cycle 6, score +0
Run 66, Cycle 7, score +0
Run 66, Cycle 8, score +0
Run 66, Cycle 9, score +0
Convergence, score=2.416314 
Run 67, Init, score 2.213052 
Run 67, Cycle 1, score +0.203262, flipped (1,1) 
Run 67, Cycle 2, score +0
Run 67, Cycle 3, score +0
Run 67, Cycle 4, score +0
Run 67, Cycle 5, score +0
Run 67, Cycle 6, score +0
Run 67, Cycle 7, score +0
Run 67, Cycle 8, score +0
Run 67, Cycle 9, score +0
Convergence, score=2.416314 
Run 68, Init, score 1.716997 
Run 68, Cycle 1, score +0.279126, flipped (8,1) 
Run 68, Cycle 2, score +0.018012, flipped (6,1) 
Run 68, Cycle 3, score +0.080315, flipped (3,1) 
Run 68, Cycle 4, score +0.233883, flipped (1,1) 
Run 68, Cycle 5, score +0.087981, flipped (8,1) 
Run 68, Cycle 6, score +0
Run 68, Cycle 7, score +0
Run 68, Cycle 8, score +0
Run 68, Cycle 9, score +0
Convergence, score=2.416314 
Run 69, Init, score 1.706988 
Run 69, Cycle 1, score +0.318509, flipped (3,1) 
Run 69, Cycle 2, score +0.194492, flipped (6,1) 
Run 69, Cycle 3, score +0.108343, flipped (2,1) 
Run 69, Cycle 4, score +0.087981, flipped (8,1) 
Run 69, Cycle 5, score +0
Run 69, Cycle 6, score +0
Run 69, Cycle 7, score +0
Run 69, Cycle 8, score +0
Run 69, Cycle 9, score +0
Convergence, score=2.416314 
Run 70, Init, score 0.668972 
Run 70, Cycle 1, score +1.134157, flipped (7,1) 
Run 70, Cycle 2, score +0.211006, flipped (2,1) 
Run 70, Cycle 3, score +0.080315, flipped (3,1) 
Run 70, Cycle 4, score +0.233883, flipped (1,1) 
Run 70, Cycle 5, score +0.087981, flipped (8,1) 
Run 70, Cycle 6, score +0
Run 70, Cycle 7, score +0
Run 70, Cycle 8, score +0
Run 70, Cycle 9, score +0
Convergence, score=2.416314 
Run 71, Init, score 1.052163 
Run 71, Cycle 1, score +0.836612, flipped (4,1) 
Run 71, Cycle 2, score +0.226747, flipped (3,1) 
Run 71, Cycle 3, score +0.212811, flipped (6,1) 
Run 71, Cycle 4, score +0.087981, flipped (8,1) 
Run 71, Cycle 5, score +0
Run 71, Cycle 6, score +0
Run 71, Cycle 7, score +0
Run 71, Cycle 8, score +0
Run 71, Cycle 9, score +0
Convergence, score=2.416314 
Run 72, Init, score 0.467071 
Run 72, Cycle 1, score +1.167960, flipped (4,1) 
Run 72, Cycle 2, score +0.476804, flipped (3,1) 
Run 72, Cycle 3, score +0.304479, flipped (6,1) 
Run 72, Cycle 4, score +0
Run 72, Cycle 5, score +0
Run 72, Cycle 6, score +0
Run 72, Cycle 7, score +0
Run 72, Cycle 8, score +0
Run 72, Cycle 9, score +0
Convergence, score=2.416314 
Run 73, Init, score 1.716997 
Run 73, Cycle 1, score +0.279126, flipped (8,1) 
Run 73, Cycle 2, score +0.018012, flipped (6,1) 
Run 73, Cycle 3, score +0.080315, flipped (3,1) 
Run 73, Cycle 4, score +0.233883, flipped (1,1) 
Run 73, Cycle 5, score +0.087981, flipped (8,1) 
Run 73, Cycle 6, score +0
Run 73, Cycle 7, score +0
Run 73, Cycle 8, score +0
Run 73, Cycle 9, score +0
Convergence, score=2.416314 
Run 74, Init, score 1.308615 
Run 74, Cycle 1, score +0.581927, flipped (5,1) 
Run 74, Cycle 2, score +0.437791, flipped (3,1) 
Run 74, Cycle 3, score +0.087981, flipped (8,1) 
Run 74, Cycle 4, score +0
Run 74, Cycle 5, score +0
Run 74, Cycle 6, score +0
Run 74, Cycle 7, score +0
Run 74, Cycle 8, score +0
Run 74, Cycle 9, score +0
Convergence, score=2.416314 
Run 75, Init, score 0.930610 
Run 75, Cycle 1, score +1.094888, flipped (4,1) 
Run 75, Cycle 2, score +0.194492, flipped (6,1) 
Run 75, Cycle 3, score +0.108343, flipped (2,1) 
Run 75, Cycle 4, score +0.087981, flipped (8,1) 
Run 75, Cycle 5, score +0
Run 75, Cycle 6, score +0
Run 75, Cycle 7, score +0
Run 75, Cycle 8, score +0
Run 75, Cycle 9, score +0
Convergence, score=2.416314 
Run 76, Init, score 0.572610 
Run 76, Cycle 1, score +1.123479, flipped (7,1) 
Run 76, Cycle 2, score +0.591972, flipped (3,1) 
Run 76, Cycle 3, score +0.128253, flipped (2,1) 
Run 76, Cycle 4, score +0
Run 76, Cycle 5, score +0
Run 76, Cycle 6, score +0
Run 76, Cycle 7, score +0
Run 76, Cycle 8, score +0
Run 76, Cycle 9, score +0
Convergence, score=2.416314 
Run 77, Init, score 1.285242 
Run 77, Cycle 1, score +0.657331, flipped (3,1) 
Run 77, Cycle 2, score +0.473740, flipped (5,1) 
Run 77, Cycle 3, score +0
Run 77, Cycle 4, score +0
Run 77, Cycle 5, score +0
Run 77, Cycle 6, score +0
Run 77, Cycle 7, score +0
Run 77, Cycle 8, score +0
Run 77, Cycle 9, score +0
Convergence, score=2.416314 
Run 78, Init, score 1.890542 
Run 78, Cycle 1, score +0.437791, flipped (3,1) 
Run 78, Cycle 2, score +0.087981, flipped (8,1) 
Run 78, Cycle 3, score +0
Run 78, Cycle 4, score +0
Run 78, Cycle 5, score +0
Run 78, Cycle 6, score +0
Run 78, Cycle 7, score +0
Run 78, Cycle 8, score +0
Run 78, Cycle 9, score +0
Convergence, score=2.416314 
Run 79, Init, score 1.113547 
Run 79, Cycle 1, score +0.695482, flipped (5,1) 
Run 79, Cycle 2, score +0.216468, flipped (1,1) 
Run 79, Cycle 3, score +0.194492, flipped (6,1) 
Run 79, Cycle 4, score +0.108343, flipped (2,1) 
Run 79, Cycle 5, score +0.087981, flipped (8,1) 
Run 79, Cycle 6, score +0
Run 79, Cycle 7, score +0
Run 79, Cycle 8, score +0
Run 79, Cycle 9, score +0
Convergence, score=2.416314 
Run 80, Init, score 1.785116 
Run 80, Cycle 1, score +0.211006, flipped (2,1) 
Run 80, Cycle 2, score +0.018012, flipped (6,1) 
Run 80, Cycle 3, score +0.080315, flipped (3,1) 
Run 80, Cycle 4, score +0.233883, flipped (1,1) 
Run 80, Cycle 5, score +0.087981, flipped (8,1) 
Run 80, Cycle 6, score +0
Run 80, Cycle 7, score +0
Run 80, Cycle 8, score +0
Run 80, Cycle 9, score +0
Convergence, score=2.416314 
Run 81, Init, score 1.735226 
Run 81, Cycle 1, score +0.477826, flipped (5,1) 
Run 81, Cycle 2, score +0.203262, flipped (1,1) 
Run 81, Cycle 3, score +0
Run 81, Cycle 4, score +0
Run 81, Cycle 5, score +0
Run 81, Cycle 6, score +0
Run 81, Cycle 7, score +0
Run 81, Cycle 8, score +0
Run 81, Cycle 9, score +0
Convergence, score=2.416314 
Run 82, Init, score 1.065259 
Run 82, Cycle 1, score +1.154731, flipped (4,1) 
Run 82, Cycle 2, score +0.108343, flipped (2,1) 
Run 82, Cycle 3, score +0.087981, flipped (8,1) 
Run 82, Cycle 4, score +0
Run 82, Cycle 5, score +0
Run 82, Cycle 6, score +0
Run 82, Cycle 7, score +0
Run 82, Cycle 8, score +0
Run 82, Cycle 9, score +0
Convergence, score=2.416314 
Run 83, Init, score 1.785116 
Run 83, Cycle 1, score +0.211006, flipped (2,1) 
Run 83, Cycle 2, score +0.018012, flipped (6,1) 
Run 83, Cycle 3, score +0.080315, flipped (3,1) 
Run 83, Cycle 4, score +0.233883, flipped (1,1) 
Run 83, Cycle 5, score +0.087981, flipped (8,1) 
Run 83, Cycle 6, score +0
Run 83, Cycle 7, score +0
Run 83, Cycle 8, score +0
Run 83, Cycle 9, score +0
Convergence, score=2.416314 
Run 84, Init, score 1.331802 
Run 84, Cycle 1, score +0.682333, flipped (5,1) 
Run 84, Cycle 2, score +0.080315, flipped (3,1) 
Run 84, Cycle 3, score +0.233883, flipped (1,1) 
Run 84, Cycle 4, score +0.087981, flipped (8,1) 
Run 84, Cycle 5, score +0
Run 84, Cycle 6, score +0
Run 84, Cycle 7, score +0
Run 84, Cycle 8, score +0
Run 84, Cycle 9, score +0
Convergence, score=2.416314 
Run 85, Init, score 1.996123 
Run 85, Cycle 1, score +0.018012, flipped (6,1) 
Run 85, Cycle 2, score +0.080315, flipped (3,1) 
Run 85, Cycle 3, score +0.233883, flipped (1,1) 
Run 85, Cycle 4, score +0.087981, flipped (8,1) 
Run 85, Cycle 5, score +0
Run 85, Cycle 6, score +0
Run 85, Cycle 7, score +0
Run 85, Cycle 8, score +0
Run 85, Cycle 9, score +0
Convergence, score=2.416314 
Run 86, Init, score 0.762707 
Run 86, Cycle 1, score +1.171949, flipped (4,1) 
Run 86, Cycle 2, score +0.278396, flipped (6,1) 
Run 86, Cycle 3, score +0.203262, flipped (1,1) 
Run 86, Cycle 4, score +0
Run 86, Cycle 5, score +0
Run 86, Cycle 6, score +0
Run 86, Cycle 7, score +0
Run 86, Cycle 8, score +0
Run 86, Cycle 9, score +0
Convergence, score=2.416314 
Run 87, Init, score 0.754825 
Run 87, Cycle 1, score +0.899517, flipped (7,1) 
Run 87, Cycle 2, score +0.435610, flipped (3,1) 
Run 87, Cycle 3, score +0.198109, flipped (1,1) 
Run 87, Cycle 4, score +0.128253, flipped (2,1) 
Run 87, Cycle 5, score +0
Run 87, Cycle 6, score +0
Run 87, Cycle 7, score +0
Run 87, Cycle 8, score +0
Run 87, Cycle 9, score +0
Convergence, score=2.416314 
Run 88, Init, score 1.084411 
Run 88, Cycle 1, score +0.911712, flipped (4,1) 
Run 88, Cycle 2, score +0.018012, flipped (6,1) 
Run 88, Cycle 3, score +0.080315, flipped (3,1) 
Run 88, Cycle 4, score +0.233883, flipped (1,1) 
Run 88, Cycle 5, score +0.087981, flipped (8,1) 
Run 88, Cycle 6, score +0
Run 88, Cycle 7, score +0
Run 88, Cycle 8, score +0
Run 88, Cycle 9, score +0
Convergence, score=2.416314 
Run 89, Init, score 1.696089 
Run 89, Cycle 1, score +0.591972, flipped (3,1) 
Run 89, Cycle 2, score +0.128253, flipped (2,1) 
Run 89, Cycle 3, score +0
Run 89, Cycle 4, score +0
Run 89, Cycle 5, score +0
Run 89, Cycle 6, score +0
Run 89, Cycle 7, score +0
Run 89, Cycle 8, score +0
Run 89, Cycle 9, score +0
Convergence, score=2.416314 
Run 90, Init, score 1.787234 
Run 90, Cycle 1, score +0.541099, flipped (5,1) 
Run 90, Cycle 2, score +0.087981, flipped (8,1) 
Run 90, Cycle 3, score +0
Run 90, Cycle 4, score +0
Run 90, Cycle 5, score +0
Run 90, Cycle 6, score +0
Run 90, Cycle 7, score +0
Run 90, Cycle 8, score +0
Run 90, Cycle 9, score +0
Convergence, score=2.416314 
Run 91, Init, score 1.511337 
Run 91, Cycle 1, score +0.490606, flipped (3,1) 
Run 91, Cycle 2, score +0.286119, flipped (6,1) 
Run 91, Cycle 3, score +0.128253, flipped (2,1) 
Run 91, Cycle 4, score +0
Run 91, Cycle 5, score +0
Run 91, Cycle 6, score +0
Run 91, Cycle 7, score +0
Run 91, Cycle 8, score +0
Run 91, Cycle 9, score +0
Convergence, score=2.416314 
Run 92, Init, score 2.094450 
Run 92, Cycle 1, score +0.233883, flipped (1,1) 
Run 92, Cycle 2, score +0.087981, flipped (8,1) 
Run 92, Cycle 3, score +0
Run 92, Cycle 4, score +0
Run 92, Cycle 5, score +0
Run 92, Cycle 6, score +0
Run 92, Cycle 7, score +0
Run 92, Cycle 8, score +0
Run 92, Cycle 9, score +0
Convergence, score=2.416314 
Run 93, Init, score 0.556344 
Run 93, Cycle 1, score +1.160652, flipped (4,1) 
Run 93, Cycle 2, score +0.279126, flipped (8,1) 
Run 93, Cycle 3, score +0.018012, flipped (6,1) 
Run 93, Cycle 4, score +0.080315, flipped (3,1) 
Run 93, Cycle 5, score +0.233883, flipped (1,1) 
Run 93, Cycle 6, score +0.087981, flipped (8,1) 
Run 93, Cycle 7, score +0
Run 93, Cycle 8, score +0
Run 93, Cycle 9, score +0
Convergence, score=2.416314 
Run 94, Init, score 1.251333 
Run 94, Cycle 1, score +0.565510, flipped (5,1) 
Run 94, Cycle 2, score +0.273109, flipped (6,1) 
Run 94, Cycle 3, score +0.198109, flipped (1,1) 
Run 94, Cycle 4, score +0.128253, flipped (2,1) 
Run 94, Cycle 5, score +0
Run 94, Cycle 6, score +0
Run 94, Cycle 7, score +0
Run 94, Cycle 8, score +0
Run 94, Cycle 9, score +0
Convergence, score=2.416314 
Run 95, Init, score 1.888775 
Run 95, Cycle 1, score +0.226747, flipped (3,1) 
Run 95, Cycle 2, score +0.212811, flipped (6,1) 
Run 95, Cycle 3, score +0.087981, flipped (8,1) 
Run 95, Cycle 4, score +0
Run 95, Cycle 5, score +0
Run 95, Cycle 6, score +0
Run 95, Cycle 7, score +0
Run 95, Cycle 8, score +0
Run 95, Cycle 9, score +0
Convergence, score=2.416314 
Run 96, Init, score 1.696089 
Run 96, Cycle 1, score +0.591972, flipped (3,1) 
Run 96, Cycle 2, score +0.128253, flipped (2,1) 
Run 96, Cycle 3, score +0
Run 96, Cycle 4, score +0
Run 96, Cycle 5, score +0
Run 96, Cycle 6, score +0
Run 96, Cycle 7, score +0
Run 96, Cycle 8, score +0
Run 96, Cycle 9, score +0
Convergence, score=2.416314 
Run 97, Init, score 1.252448 
Run 97, Cycle 1, score +0.569408, flipped (5,1) 
Run 97, Cycle 2, score +0.391196, flipped (3,1) 
Run 97, Cycle 3, score +0.203262, flipped (1,1) 
Run 97, Cycle 4, score +0
Run 97, Cycle 5, score +0
Run 97, Cycle 6, score +0
Run 97, Cycle 7, score +0
Run 97, Cycle 8, score +0
Run 97, Cycle 9, score +0
Convergence, score=2.416314 
Run 98, Init, score 1.348806 
Run 98, Cycle 1, score +0.676692, flipped (5,1) 
Run 98, Cycle 2, score +0.194492, flipped (6,1) 
Run 98, Cycle 3, score +0.108343, flipped (2,1) 
Run 98, Cycle 4, score +0.087981, flipped (8,1) 
Run 98, Cycle 5, score +0
Run 98, Cycle 6, score +0
Run 98, Cycle 7, score +0
Run 98, Cycle 8, score +0
Run 98, Cycle 9, score +0
Convergence, score=2.416314 
Run 99, Init, score 0.985879 
Run 99, Cycle 1, score +0.721109, flipped (5,1) 
Run 99, Cycle 2, score +0.318509, flipped (3,1) 
Run 99, Cycle 3, score +0.194492, flipped (6,1) 
Run 99, Cycle 4, score +0.108343, flipped (2,1) 
Run 99, Cycle 5, score +0.087981, flipped (8,1) 
Run 99, Cycle 6, score +0
Run 99, Cycle 7, score +0
Run 99, Cycle 8, score +0
Run 99, Cycle 9, score +0
Convergence, score=2.416314 
Run 100, Init, score 0.628563 
Run 100, Cycle 1, score +1.193293, flipped (4,1) 
Run 100, Cycle 2, score +0.391196, flipped (3,1) 
Run 100, Cycle 3, score +0.203262, flipped (1,1) 
Run 100, Cycle 4, score +0
Run 100, Cycle 5, score +0
Run 100, Cycle 6, score +0
Run 100, Cycle 7, score +0
Run 100, Cycle 8, score +0
Run 100, Cycle 9, score +0
Convergence, score=2.416314 
Final Score=2.416314
</pre><h2 id="9">And run the HMM-MAR on this</h2><pre class="codeinput">options = struct();
options.K = 3; <span class="comment">% number of states</span>
options.order =  4; <span class="comment">% MAR order</span>
options.covtype = <span class="string">'full'</span>;
options.cyc = 100;
options.initcyc = 10;
options.initrep = 3;
options.verbose = 1; <span class="comment">% show progress?</span>
<span class="keyword">if</span> do_analysis
    [hmm_raw,Gamma_raw] = hmmmar(X,T,options);
<span class="keyword">else</span>
    load(hmmmar_name,<span class="string">'hmm_raw'</span>,<span class="string">'Gamma_raw'</span>)
<span class="keyword">end</span>
</pre><h2 id="10">Compute the spectral information of the states (power, coherence, etc)</h2><p>Because a MAR model implicitly contains all the spectral information, we can use the parameters to derive power, coherence, phase relations, etc.</p><pre class="codeinput">options = struct();
options.fpass = [1 40]; <span class="comment">% frequency range we want to look at</span>
options.Nf = 100; <span class="comment">% number of frequency bins</span>
options.Fs = 200; <span class="comment">% sampling frequency in hertzs</span>
options.order = 11;

<span class="keyword">if</span> do_analysis
    spectra_raw = hmmspectramar(X,T,[],Gamma_raw,options);
<span class="keyword">else</span>
    load(hmmmar_name,<span class="string">'spectra_raw'</span>)
<span class="keyword">end</span>
</pre><h2 id="11">Now we do some plotting of the HMM on power envelopes and HMM-MAR results</h2><p>computed above</p><pre class="codeinput"><span class="comment">% Because the number of cycles was set to such a low number,</span>
<span class="comment">% we reload a pre-computed run, which would have taken a bit longer</span>

load(hmmmar_name)
</pre><h2 id="12">Now let's see the state evoked probability, locked to the stimulus</h2><p>the stimulus is saved in the variable onset, which contains a (Tx1) logical vector with 1 when the fingertapping is effected.</p><pre class="codeinput">subjects = [1 2 4 5 6 7 8 9]; <span class="comment">% index of the subjects</span>
Hz = 200; <span class="comment">% sampling frequency</span>
L = 8; <span class="comment">% length of the window around the stimulus (seconds)</span>
window = Hz*L+1;

<span class="comment">% "evoked state response" around the stimulus, for the envelope run</span>
evokedGamma_env = zeros(window,hmm_env.K,length(subjects));
t0 = 0;
<span class="keyword">for</span> j = subjects <span class="comment">% iterate through subjects</span>
    file = fullfile(data_dir,[<span class="string">'sub'</span> num2str(j) <span class="string">'.mat'</span>]);
    load(file,<span class="string">'onset'</span>); <span class="comment">% load the data</span>
    T = length(onset);
    index = t0 + (1:T);
    Gamma_subj = Gamma_env(index,:); <span class="comment">% state time course of this subject</span>
    evokedGamma_env(:,:,j) = evokedStateProbability(onset,T,Gamma_subj,window);
    t0 = t0 + length(index);
<span class="keyword">end</span>
evokedGamma_env = mean(evokedGamma_env,3); <span class="comment">% average across subjects</span>

<span class="comment">% "evoked state response" around the stimulus, for the envelope run</span>
evokedGamma_raw = zeros(window,hmm_env.K,length(subjects));
t0 = 0;
<span class="keyword">for</span> j = subjects <span class="comment">% iterate through subjects</span>
    file = fullfile(data_dir,[<span class="string">'sub'</span> num2str(j) <span class="string">'.mat'</span>]);
    load(file,<span class="string">'onset'</span>); <span class="comment">% load the data</span>
    T = length(onset);
    index = t0 + (1:T-hmm_raw.train.order);
    Gamma_subj = Gamma_raw(index,:); <span class="comment">% state time course of this subject</span>
    evokedGamma_raw(:,:,j) = evokedStateProbability(onset,T,Gamma_subj,window);
    t0 = t0 + length(index);
<span class="keyword">end</span>
evokedGamma_raw = mean(evokedGamma_raw,3); <span class="comment">% average across subjects</span>

<span class="comment">% And plot both</span>
figure(1);
halfwindow = (window-1)/2;
<span class="comment">% Evoked state response for the HMM on power envelopes</span>
subplot(1,2,1)
plot((-halfwindow:halfwindow)/Hz,evokedGamma_env,<span class="string">'LineWidth'</span>,2)
xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontSize'</span>,15)
ylabel(<span class="string">'State probability'</span>,<span class="string">'FontSize'</span>,15)
title(<span class="string">'HMM on envelope'</span>,<span class="string">'FontSize'</span>,17)
ylim([0.05 0.7])
<span class="comment">% Evoked state response for the HMM-MAR</span>
subplot(1,2,2)
plot((-halfwindow:halfwindow)/Hz,evokedGamma_raw,<span class="string">'LineWidth'</span>,2)
xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontSize'</span>,15)
ylabel(<span class="string">'State probability'</span>,<span class="string">'FontSize'</span>,15)
title(<span class="string">'HMM-MAR on raw signals'</span>,<span class="string">'FontSize'</span>,17)
ylim([0.05 0.7])
</pre><img vspace="5" hspace="5" src="osl_example_hmmmar_01.png" alt=""> <h2 id="13">Show the spectral info (power and coherence) for the</h2><p>HMM on power envelopes and HMM-MAR</p><pre class="codeinput">colors = {<span class="string">'b'</span>,[0.2 0.7 0.2],<span class="string">'r'</span>};

<span class="comment">% Non-parametric spectra from the HMM on power envelopes</span>
figure(2);clf(2)
<span class="keyword">for</span> k=1:hmm_env.K
    subplot(2,2,1)
    hold <span class="string">on</span>
    plot(spectra_env.state(k).f,spectra_env.state(k).psd(:,1,1),<span class="string">'Color'</span>,colors{k},<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
    subplot(2,2,4)
    hold <span class="string">on</span>
    plot(spectra_env.state(k).f,spectra_env.state(k).psd(:,2,2),<span class="string">'Color'</span>,colors{k}',<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
    subplot(2,2,3)
    hold <span class="string">on</span>
    plot(spectra_env.state(k).f,spectra_env.state(k).coh(:,1,2),<span class="string">'Color'</span>,colors{k},<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
<span class="keyword">end</span>
subplot(2,2,1)
title(<span class="string">'Power Chan1, HMM-Gaussian'</span>,<span class="string">'FontSize'</span>,16)
subplot(2,2,4)
title(<span class="string">'Power Chan2, HMM-Gaussian'</span>,<span class="string">'FontSize'</span>,16)
subplot(2,2,3)
title(<span class="string">'Coherence, HMM-Gaussian'</span>,<span class="string">'FontSize'</span>,16)

<span class="comment">% Parametric spectra (MAR-based) from the HMM-MAR</span>
figure(3);clf(3)
<span class="keyword">for</span> k=1:hmm_env.K
    subplot(2,2,1)
    hold <span class="string">on</span>
    plot(spectra_raw.state(k).f,spectra_raw.state(k).psd(:,1,1),<span class="string">'Color'</span>,colors{k},<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
    subplot(2,2,4)
    hold <span class="string">on</span>
    plot(spectra_raw.state(k).f,spectra_raw.state(k).psd(:,2,2),<span class="string">'Color'</span>,colors{k}',<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
    subplot(2,2,3)
    hold <span class="string">on</span>
    plot(spectra_raw.state(k).f,spectra_raw.state(k).coh(:,1,2),<span class="string">'Color'</span>,colors{k},<span class="string">'LineWidth'</span>,2);xlim([4 30])
    set(gca,<span class="string">'FontSize'</span>,14)
    hold <span class="string">off</span>
<span class="keyword">end</span>
set(gca,<span class="string">'FontSize'</span>,14)
subplot(2,2,1)
title(<span class="string">'Power Chan1, HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
subplot(2,2,4)
title(<span class="string">'Power Chan2, HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
subplot(2,2,3)
title(<span class="string">'Coherence, HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
</pre><img vspace="5" hspace="5" src="osl_example_hmmmar_02.png" alt=""> <img vspace="5" hspace="5" src="osl_example_hmmmar_03.png" alt=""> <h2 id="14">HMM-based Time-frequency analysis</h2><p>Given the higher sensitivity of the HMM-MAR spectra, apparent in the previous block, we focus here just on the HMM-MAR results</p><pre class="codeinput">[psd_tf,coh_tf] = hmmtimefreq(spectra_raw,evokedGamma_raw,1);
f = spectra_raw.state(1).f ;
indf = f&gt;4 &amp; f&lt;=30;
f = f(indf);

figure(4);clf(4)
subplot(3,1,1)
l = max(max(max(abs(psd_tf(indf,:,1)))),max(max(abs(psd_tf(indf,:,1)))));
imagesc((-halfwindow:halfwindow)/Hz,f,psd_tf(:,indf,1)',[-l l]);colorbar
hold <span class="string">on</span>; plot([0 0],[4 30],<span class="string">'k'</span>); hold <span class="string">off</span>
xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontSize'</span>,14); ylabel(<span class="string">'Frequency (Hz)'</span>,<span class="string">'FontSize'</span>,14);
title(<span class="string">'Power channel 1 : HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
subplot(3,1,2)
imagesc((-halfwindow:halfwindow)/Hz,f,psd_tf(:,indf,2)',[-l l]);colorbar
hold <span class="string">on</span>; plot([0 0],[4 30],<span class="string">'k'</span>); hold <span class="string">off</span>
xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontSize'</span>,14); ylabel(<span class="string">'Frequency (Hz)'</span>,<span class="string">'FontSize'</span>,14);
title(<span class="string">'Power channel 2 : HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
subplot(3,1,3)
l = max(max(abs(coh_tf(indf,:,1,2))));
imagesc((-halfwindow:halfwindow)/Hz,f,coh_tf(:,indf,1,2)',[-l l]);colorbar
hold <span class="string">on</span>; plot([0 0],[4 30],<span class="string">'k'</span>); hold <span class="string">off</span>
xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontSize'</span>,14); ylabel(<span class="string">'Frequency (Hz)'</span>,<span class="string">'FontSize'</span>,14);
title(<span class="string">'Coherence : HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
</pre><img vspace="5" hspace="5" src="osl_example_hmmmar_04.png" alt=""> <h2 id="15">Probability of transit between states for the</h2><p>HMM on power envelopes and HMM-MAR</p><pre class="codeinput">P_env = hmm_env.P;
<span class="comment">% We normalize, such that we focus on the between state transitions</span>
<span class="keyword">for</span> k=1:3
    P_env(k,k) = 0;
    P_env(k,:) = P_env(k,:) / sum(P_env(k,:));
<span class="keyword">end</span>
disp(<span class="string">'HMM-Gaussian Probability of transition from state i to state j'</span>)
P_env


P_raw = hmm_raw.P;
<span class="comment">% We normalize, such that we focus on the between state transitions</span>
<span class="keyword">for</span> k=1:3
    P_raw(k,k) = 0;
    P_raw(k,:) = P_raw(k,:) / sum(P_raw(k,:));
<span class="keyword">end</span>
disp(<span class="string">'HMM-MAR Probability of transition from state i to state j'</span>)
P_raw



figure(5)

<span class="comment">% plot trans prob matrix for the HMM-Gaussian</span>
subplot(1,2,1)
imagesc(P_env);colorbar
title(<span class="string">'Transition probability matrix for the HMM-Gaussian'</span>,<span class="string">'FontSize'</span>,16)
set(gca,<span class="string">'Xtick'</span>,1:3,<span class="string">'ytick'</span>,1:3,<span class="string">'FontSize'</span>,14)
xlabel(<span class="string">'To'</span>,<span class="string">'FontSize'</span>,16)
ylabel(<span class="string">'From'</span>,<span class="string">'FontSize'</span>,16)

<span class="comment">% plot trans prob matrix for the HMM-MAR</span>
subplot(1,2,2)
imagesc(P_raw);colorbar
title(<span class="string">'Transition probability matrix for the HMM-MAR'</span>,<span class="string">'FontSize'</span>,16)
set(gca,<span class="string">'Xtick'</span>,1:3,<span class="string">'ytick'</span>,1:3,<span class="string">'FontSize'</span>,14)
xlabel(<span class="string">'To'</span>,<span class="string">'FontSize'</span>,16)
ylabel(<span class="string">'From'</span>,<span class="string">'FontSize'</span>,16)
</pre><pre class="">HMM-Gaussian Probability of transition from state i to state j

P_env =

         0    0.2770    0.7230
    0.4971         0    0.5029
    0.7224    0.2776         0

HMM-MAR Probability of transition from state i to state j

P_raw =

         0    0.3822    0.6178
    0.2984         0    0.7016
    0.4318    0.5682         0

</pre><img vspace="5" hspace="5" src="osl_example_hmmmar_05.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2013b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% HMM-MAR 
% This example shows how to use the HMM-MAR to infer transient states that:
% (i) are spectrally defined, i.e. the characteristics of interest are defined as a function of frequency.
% (ii) are based on the raw time series, i.e. we do not need to bandpass filter or compute power envelopes.
% (iii) are not only sensitive to power differences but also to phase coupling.
% The script infers a group (spectrally-defined) HMM from source space MEG data, following the paper
% Vidaurre et al, NeuroImage (2016)
%%

% Directory of the data:
data_dir = fullfile(osldir,'example_data','hmmmar_example');
% Name for this HMM-MAR analysis:
hmmmar_name = fullfile(osldir,'example_data','hmmmar_example','hmmmar_demo.mat');

% Set |do_analysis=1| to re-run the analysis, otherwise use precomputed result
do_analysis = 0; 

%% 1) HMM-MAR on hilbert envelopes 
% Such as in Baker et al, Elife (2014)
%% Loading and preparing the data

% We are going to concatenate data into a single matrix
% (if data is too big, the file names can also be provided to the hmmmar function)
X = []; % data, time by regions
T = []; % length of trials, a vector containing how long is each session/trial/subject

subjects = [1 2 4 5 6 7 8 9]; % index of the subjects
N = length(subjects);

for j = subjects % iterate through subjects
    file = fullfile(data_dir,['sub' num2str(j) '.mat']);
    load(file); % load the data
    sourcedata = sourcedata' ; % we need it (time by channels)
    T = [T size(sourcedata,1)]; % time length of this subject
    for i=1:size(sourcedata,2)
        sourcedata(:,i) = abs(hilbert(sourcedata(:,i))); % Hilbert envelope
    end
    sourcedata = zscore(sourcedata); % standardize subject such that it has mean 0 and stdev 1
    X = [X; sourcedata]; % concat subject
end

%% Prepare the HMM options and run the HMMMAR
    
options = struct();
options.K = 3; % number of states
options.order =  0; % order 0 means a Gaussian distribution (adequate for power time series)
options.covtype = 'full'; 
% model connectivity, covtype='full' means that we model the covariance between regions
options.zeromean = 0; 
% zeromean=0 means that we model the mean, i.e. model the "amount of power"
% zeromean=1 means that we do *not* model the mean
options.cyc = 100;  
options.initcyc = 10;  
options.initrep = 3;  
options.verbose = 1; % show progress?
if do_analysis
    [hmm_env,Gamma_env] = hmmmar(X,T,options);
else
    load(hmmmar_name,'hmm_env','Gamma_env')
end

%% Compute the spectral information of the states (power, coherence, etc) 
% using a weighted version of the multitaper
% Note that we can't get an estimation of the spectra directly from the
% parameters in this case, as the HMM has been run in wideband power time series

options = struct();
options.fpass = [1 40]; % frequency range we want to look at
options.tapers = [4 7]; % internal multitaper parameter
options.Fs = 200; % sampling frequency in hertzs
options.win = 10 * options.Fs; % window, related to the level of detail in frequency of the estimation

if do_analysis
    spectra_env = hmmspectramt(X,T,Gamma_env,options);
else
    load(hmmmar_name,'spectra_env')
end

%% 2) HMM-MAR on raw signals 
% Such as in Vidaurre et al, NeuroImage (2016)
%% Loading and preparing the data

% We are going to concatenate data into a single matrix
% (if data is too big, the file names can also be provided to the hmmmar function)
X = []; % data, time by regions
T = []; % length of trials, a vector containing how long is each session/trial/subject

subjects = [1 2 4 5 6 7 8 9]; % index of the subjects
N = length(subjects);

for j = subjects % iterate through subjects
    file = fullfile(data_dir,['sub' num2str(j) '.mat']);
    load(file); % load the data
    sourcedata = sourcedata' ; % we need it (time by channels)
    T = [T size(sourcedata,1)]; % time length of this subject
    sourcedata = zscore(sourcedata); % standardize subject such that it has mean 0 and stdev 1
    X = [X; sourcedata]; % concat subject
end

%% Signs might be arbitrarily flipped, so we need to disambiguate this
% this is because the intrinsic ambiguity in source-reconstructed signals

options = struct();
options.maxlag = 8;
options.noruns = 100;

[flips,scorepath] = findflip(X,T,options);
X = flipdata(X,T,flips);

%% And run the HMM-MAR on this

options = struct();
options.K = 3; % number of states
options.order =  4; % MAR order 
options.covtype = 'full';
options.cyc = 100;  
options.initcyc = 10;  
options.initrep = 3;
options.verbose = 1; % show progress?
if do_analysis
    [hmm_raw,Gamma_raw] = hmmmar(X,T,options);
else
    load(hmmmar_name,'hmm_raw','Gamma_raw')
end

%% Compute the spectral information of the states (power, coherence, etc) 
% Because a MAR model implicitly contains all the spectral information, 
% we can use the parameters to derive power, coherence, phase relations, etc.

options = struct();
options.fpass = [1 40]; % frequency range we want to look at
options.Nf = 100; % number of frequency bins
options.Fs = 200; % sampling frequency in hertzs
options.order = 11;

if do_analysis
    spectra_raw = hmmspectramar(X,T,[],Gamma_raw,options);
else
    load(hmmmar_name,'spectra_raw')
end

%% Now we do some plotting of the HMM on power envelopes and HMM-MAR results
% computed above

% Because the number of cycles was set to such a low number, 
% we reload a pre-computed run, which would have taken a bit longer

load(hmmmar_name)

%% Now let's see the state evoked probability, locked to the stimulus
% the stimulus is saved in the variable onset, which contains a (Tx1)
% logical vector with 1 when the fingertapping is effected. 

subjects = [1 2 4 5 6 7 8 9]; % index of the subjects
Hz = 200; % sampling frequency
L = 8; % length of the window around the stimulus (seconds)
window = Hz*L+1;

% "evoked state response" around the stimulus, for the envelope run
evokedGamma_env = zeros(window,hmm_env.K,length(subjects));
t0 = 0;
for j = subjects % iterate through subjects
    file = fullfile(data_dir,['sub' num2str(j) '.mat']);
    load(file,'onset'); % load the data
    T = length(onset);
    index = t0 + (1:T);
    Gamma_subj = Gamma_env(index,:); % state time course of this subject
    evokedGamma_env(:,:,j) = evokedStateProbability(onset,T,Gamma_subj,window); 
    t0 = t0 + length(index);
end
evokedGamma_env = mean(evokedGamma_env,3); % average across subjects

% "evoked state response" around the stimulus, for the envelope run
evokedGamma_raw = zeros(window,hmm_env.K,length(subjects));
t0 = 0;
for j = subjects % iterate through subjects
    file = fullfile(data_dir,['sub' num2str(j) '.mat']);
    load(file,'onset'); % load the data
    T = length(onset);
    index = t0 + (1:T-hmm_raw.train.order);
    Gamma_subj = Gamma_raw(index,:); % state time course of this subject
    evokedGamma_raw(:,:,j) = evokedStateProbability(onset,T,Gamma_subj,window);
    t0 = t0 + length(index);
end
evokedGamma_raw = mean(evokedGamma_raw,3); % average across subjects
 
% And plot both 
figure(1);
halfwindow = (window-1)/2;
% Evoked state response for the HMM on power envelopes
subplot(1,2,1)
plot((-halfwindow:halfwindow)/Hz,evokedGamma_env,'LineWidth',2)
xlabel('Time (s)','FontSize',15)
ylabel('State probability','FontSize',15)
title('HMM on envelope','FontSize',17)
ylim([0.05 0.7])
% Evoked state response for the HMM-MAR
subplot(1,2,2)
plot((-halfwindow:halfwindow)/Hz,evokedGamma_raw,'LineWidth',2)
xlabel('Time (s)','FontSize',15)
ylabel('State probability','FontSize',15)
title('HMM-MAR on raw signals','FontSize',17)
ylim([0.05 0.7])

%% Show the spectral info (power and coherence) for the 
% HMM on power envelopes and HMM-MAR

colors = {'b',[0.2 0.7 0.2],'r'};

% Non-parametric spectra from the HMM on power envelopes
figure(2);clf(2)  
for k=1:hmm_env.K
    subplot(2,2,1)
    hold on
    plot(spectra_env.state(k).f,spectra_env.state(k).psd(:,1,1),'Color',colors{k},'LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
    subplot(2,2,4)
    hold on
    plot(spectra_env.state(k).f,spectra_env.state(k).psd(:,2,2),'Color',colors{k}','LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
    subplot(2,2,3)
    hold on
    plot(spectra_env.state(k).f,spectra_env.state(k).coh(:,1,2),'Color',colors{k},'LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
end
subplot(2,2,1)
title('Power Chan1, HMM-Gaussian','FontSize',16)
subplot(2,2,4)
title('Power Chan2, HMM-Gaussian','FontSize',16)
subplot(2,2,3)
title('Coherence, HMM-Gaussian','FontSize',16)

% Parametric spectra (MAR-based) from the HMM-MAR
figure(3);clf(3)  
for k=1:hmm_env.K
    subplot(2,2,1)
    hold on
    plot(spectra_raw.state(k).f,spectra_raw.state(k).psd(:,1,1),'Color',colors{k},'LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
    subplot(2,2,4)
    hold on
    plot(spectra_raw.state(k).f,spectra_raw.state(k).psd(:,2,2),'Color',colors{k}','LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
    subplot(2,2,3)
    hold on
    plot(spectra_raw.state(k).f,spectra_raw.state(k).coh(:,1,2),'Color',colors{k},'LineWidth',2);xlim([4 30])
    set(gca,'FontSize',14)
    hold off
end
set(gca,'FontSize',14)
subplot(2,2,1)
title('Power Chan1, HMM-MAR','FontSize',16)
subplot(2,2,4)
title('Power Chan2, HMM-MAR','FontSize',16)
subplot(2,2,3)
title('Coherence, HMM-MAR','FontSize',16)


%% HMM-based Time-frequency analysis
% Given the higher sensitivity of the HMM-MAR spectra, apparent in the
% previous block, we focus here just on the HMM-MAR results 

[psd_tf,coh_tf] = hmmtimefreq(spectra_raw,evokedGamma_raw,1);
f = spectra_raw.state(1).f ;
indf = f>4 & f<=30;
f = f(indf);

figure(4);clf(4)
subplot(3,1,1)
l = max(max(max(abs(psd_tf(indf,:,1)))),max(max(abs(psd_tf(indf,:,1)))));
imagesc((-halfwindow:halfwindow)/Hz,f,psd_tf(:,indf,1)',[-l l]);colorbar
hold on; plot([0 0],[4 30],'k'); hold off
xlabel('Time (s)','FontSize',14); ylabel('Frequency (Hz)','FontSize',14);
title('Power channel 1 : HMM-MAR','FontSize',16)
subplot(3,1,2)
imagesc((-halfwindow:halfwindow)/Hz,f,psd_tf(:,indf,2)',[-l l]);colorbar
hold on; plot([0 0],[4 30],'k'); hold off
xlabel('Time (s)','FontSize',14); ylabel('Frequency (Hz)','FontSize',14);
title('Power channel 2 : HMM-MAR','FontSize',16)
subplot(3,1,3)
l = max(max(abs(coh_tf(indf,:,1,2))));
imagesc((-halfwindow:halfwindow)/Hz,f,coh_tf(:,indf,1,2)',[-l l]);colorbar
hold on; plot([0 0],[4 30],'k'); hold off
xlabel('Time (s)','FontSize',14); ylabel('Frequency (Hz)','FontSize',14);
title('Coherence : HMM-MAR','FontSize',16)


%% Probability of transit between states for the 
% HMM on power envelopes and HMM-MAR

P_env = hmm_env.P; 
% We normalize, such that we focus on the between state transitions
for k=1:3
    P_env(k,k) = 0;
    P_env(k,:) = P_env(k,:) / sum(P_env(k,:));
end
disp('HMM-Gaussian Probability of transition from state i to state j')
P_env


P_raw = hmm_raw.P; 
% We normalize, such that we focus on the between state transitions
for k=1:3
    P_raw(k,k) = 0;
    P_raw(k,:) = P_raw(k,:) / sum(P_raw(k,:));
end
disp('HMM-MAR Probability of transition from state i to state j')
P_raw



figure(5)

% plot trans prob matrix for the HMM-Gaussian
subplot(1,2,1)
imagesc(P_env);colorbar
title('Transition probability matrix for the HMM-Gaussian','FontSize',16)
set(gca,'Xtick',1:3,'ytick',1:3,'FontSize',14)
xlabel('To','FontSize',16)
ylabel('From','FontSize',16)

% plot trans prob matrix for the HMM-MAR
subplot(1,2,2)
imagesc(P_raw);colorbar
title('Transition probability matrix for the HMM-MAR','FontSize',16)
set(gca,'Xtick',1:3,'ytick',1:3,'FontSize',14)
xlabel('To','FontSize',16)
ylabel('From','FontSize',16)



##### SOURCE END #####
--></body></html>