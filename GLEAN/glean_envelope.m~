function glean_envelope(GLEAN)
% Runs the envelope stage of GLEAN

if ~isfield(GLEAN.envelope,'data')
    GLEAN.envelope.data = cell(size(GLEAN.data));
end

for session = 1:numel(GLEAN.data)
    
    data_fname        = GLEAN.data{session};
    [~,session_fname] = fileparts(GLEAN.data{session});
    envelope_fname    = fullfile(GLEAN.envelope.dir,'data',[session_fname,'.mat']);
    
    if ~exist(envelope_fname,'file')
        
        % Make a temporary filename to copy raw data to
        [~,tempdata] = fileparts(tempname);
        tempdata = fullfile(fileparts(envelope_fname),[tempdata '.mat']);
        
        % Copy data to HMM directory with a temporary filename
        D = spm_eeg_load(data_fname);
        copy(D,tempdata);
        clear D
        
        % Compute envelopes
        S               = [];
        S.D             = tempdata;
        S.fsample_new   = GLEAN.envelope.settings.fsample;
        S.logtrans      = GLEAN.envelope.settings.log;
        if isfield(GLEAN.envelope.settings,'freqbands')
            S.freqbands = GLEAN.envelope.settings.freqbands;
        else
            S.freqbands = [];
        end
        S.demean    = 0;
        S.prefix    = '';
        D = glean_hilbenv(S);
        
        % Rename file
        move(D,envelope_fname);
        
        % Tidy up
        system(['rm ',strrep(tempdata,'.mat','.*at')])

    end
    
    % Populate GLEAN.envelope.data with session
    GLEAN.envelope.data{session} = envelope_fname;
    
end

end
