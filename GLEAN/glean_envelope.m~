function glean_envelope(GLEAN)
% Runs the envelope stage of GLEAN

datasets = {'subspace','beamformed'};

for session = 1:numel(GLEAN.data)
    
    for dataset = datasets
        
        data     = GLEAN.data(session).(char(dataset));
        envelope = GLEAN.data(session).([char(dataset) '_envelopes']);
        
        if ~exist(GLEAN.data(session).([char(dataset) '_envelopes']),'file')
            
            % Make a temporary filename to copy raw data to
            [~,tempdata] = fileparts(tempname);
            tempdata = fullfile(fileparts(GLEAN.data(1).enveloped),[tempdata '.mat']);
            
            % Copy data to HMM directory with a temporary filename
            D = spm_eeg_load(GLEAN.data(session).subspace);
            copy(D,tempdata);
            clear D
            
            % Compute envelopes
            S               = [];
            S.D             = tempdata;
            S.fsample_new   = GLEAN.settings.envelope.fsample;
            S.logtrans      = GLEAN.settings.envelope.log;
            if isfield(GLEAN.settings.envelope,'freqbands')
                S.freqbands = GLEAN.settings.envelope.freqbands;
            else
                S.freqbands = [];
            end
            S.demean    = 0;
            S.prefix    = '';
            D = glean_hilbenv(S);
            
            % Rename file
            D = move(D,GLEAN.data(session).enveloped);
            system(['rm ',strrep(tempdata,'.mat','.*at')])
            
        end
        
    end
    
end

end
